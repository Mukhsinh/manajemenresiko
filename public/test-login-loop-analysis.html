<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Loop Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .analysis-container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 2rem;
        }
        .log-output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
        .status-info { background-color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <div class="analysis-container">
            <h1 class="text-center mb-4">
                <i class="fas fa-search"></i> Login Loop Analysis
            </h1>
            
            <div class="alert alert-info">
                <h5><i class="fas fa-info-circle"></i> Analisis Masalah</h5>
                <p>Tool ini menganalisis masalah login berulang (masuk otomatis lalu keluar lagi) dengan memantau:</p>
                <ul>
                    <li>Auth state changes</li>
                    <li>Session storage</li>
                    <li>Token expiration</li>
                    <li>Multiple auth listeners</li>
                </ul>
            </div>

            <!-- Status Dashboard -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6>Auth State</h6>
                            <div id="auth-status">
                                <span class="status-indicator status-info"></span>
                                <span id="auth-status-text">Checking...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6>Session</h6>
                            <div id="session-status">
                                <span class="status-indicator status-info"></span>
                                <span id="session-status-text">Checking...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6>Auth Changes</h6>
                            <div id="auth-changes">
                                <span class="status-indicator status-info"></span>
                                <span id="auth-changes-text">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6>Loop Detected</h6>
                            <div id="loop-status">
                                <span class="status-indicator status-success"></span>
                                <span id="loop-status-text">No</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-play"></i> Analysis Controls</h5>
                </div>
                <div class="card-body">
                    <div class="btn-group me-2" role="group">
                        <button onclick="startAnalysis()" class="btn btn-primary" id="start-btn">
                            <i class="fas fa-play"></i> Start Analysis
                        </button>
                        <button onclick="stopAnalysis()" class="btn btn-secondary" id="stop-btn" disabled>
                            <i class="fas fa-stop"></i> Stop Analysis
                        </button>
                        <button onclick="clearLogs()" class="btn btn-outline-secondary">
                            <i class="fas fa-trash"></i> Clear Logs
                        </button>
                    </div>
                    <div class="btn-group" role="group">
                        <button onclick="testLogin()" class="btn btn-success">
                            <i class="fas fa-sign-in-alt"></i> Test Login
                        </button>
                        <button onclick="testLogout()" class="btn btn-warning">
                            <i class="fas fa-sign-out-alt"></i> Test Logout
                        </button>
                    </div>
                </div>
            </div>

            <!-- Log Output -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-terminal"></i> Analysis Log</h5>
                </div>
                <div class="card-body">
                    <div id="log-output" class="log-output">
                        Waiting for analysis to start...
                    </div>
                </div>
            </div>

            <!-- Findings -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-clipboard-list"></i> Findings & Recommendations</h5>
                </div>
                <div class="card-body">
                    <div id="findings">
                        <p class="text-muted">Start analysis to see findings...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Load Config -->
    <script src="/js/config.js"></script>
    
    <!-- Load Services -->
    <script src="/js/services/apiService.js"></script>
    <script src="/js/services/authService.js"></script>
    
    <script>
        let analysisRunning = false;
        let authChangeCount = 0;
        let authSubscription = null;
        let analysisInterval = null;
        let logOutput = document.getElementById('log-output');
        
        // Status elements
        let authStatusText = document.getElementById('auth-status-text');
        let sessionStatusText = document.getElementById('session-status-text');
        let authChangesText = document.getElementById('auth-changes-text');
        let loopStatusText = document.getElementById('loop-status-text');
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '❌' : type === 'warning' ? '⚠️' : type === 'success' ? '✅' : 'ℹ️';
            logOutput.textContent += `[${timestamp}] ${icon} ${message}\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        function clearLogs() {
            logOutput.textContent = '';
            addLog('Logs cleared');
        }
        
        function updateStatus(element, text, type = 'info') {
            element.textContent = text;
            const indicator = element.parentElement.querySelector('.status-indicator');
            indicator.className = `status-indicator status-${type}`;
        }
        
        async function checkAuthState() {
            try {
                if (!window.supabaseClient) {
                    addLog('Supabase client not available', 'error');
                    updateStatus(authStatusText, 'No Client', 'error');
                    return;
                }
                
                const { data: { session }, error } = await window.supabaseClient.auth.getSession();
                
                if (error) {
                    addLog(`Session check error: ${error.message}`, 'error');
                    updateStatus(authStatusText, 'Error', 'error');
                    updateStatus(sessionStatusText, 'Error', 'error');
                    return;
                }
                
                if (session) {
                    addLog(`Session found: ${session.user.email}`, 'success');
                    updateStatus(authStatusText, 'Authenticated', 'success');
                    updateStatus(sessionStatusText, 'Active', 'success');
                    
                    // Check token expiration
                    const now = Math.floor(Date.now() / 1000);
                    const isExpired = now >= session.expires_at;
                    
                    if (isExpired) {
                        addLog('Token is expired!', 'warning');
                        updateStatus(sessionStatusText, 'Expired', 'warning');
                    }
                } else {
                    addLog('No active session', 'info');
                    updateStatus(authStatusText, 'Not Authenticated', 'warning');
                    updateStatus(sessionStatusText, 'None', 'warning');
                }
                
            } catch (error) {
                addLog(`Auth state check failed: ${error.message}`, 'error');
                updateStatus(authStatusText, 'Error', 'error');
            }
        }
        
        function setupAuthListener() {
            if (!window.supabaseClient) {
                addLog('Cannot setup auth listener - no Supabase client', 'error');
                return;
            }
            
            addLog('Setting up auth state listener...', 'info');
            
            const { data: { subscription } } = window.supabaseClient.auth.onAuthStateChange((event, session) => {
                authChangeCount++;
                updateStatus(authChangesText, authChangeCount.toString(), authChangeCount > 3 ? 'warning' : 'info');
                
                addLog(`Auth state change #${authChangeCount}: ${event}`, 'info');
                
                if (session) {
                    addLog(`  User: ${session.user.email}`, 'info');
                    addLog(`  Token: ${session.access_token.substring(0, 20)}...`, 'info');
                } else {
                    addLog('  No session', 'info');
                }
                
                // Detect potential loop
                if (authChangeCount > 5) {
                    addLog('POTENTIAL LOOP DETECTED: Too many auth state changes!', 'error');
                    updateStatus(loopStatusText, 'Yes', 'error');
                    
                    // Auto-stop analysis if loop detected
                    if (authChangeCount > 10) {
                        addLog('Auto-stopping analysis due to excessive auth changes', 'warning');
                        stopAnalysis();
                    }
                }
            });
            
            authSubscription = subscription;
        }
        
        async function startAnalysis() {
            if (analysisRunning) return;
            
            analysisRunning = true;
            authChangeCount = 0;
            
            document.getElementById('start-btn').disabled = true;
            document.getElementById('stop-btn').disabled = false;
            
            addLog('Starting login loop analysis...', 'info');
            updateStatus(authChangesText, '0', 'info');
            updateStatus(loopStatusText, 'No', 'success');
            
            // Wait for Supabase client
            if (!window.supabaseClient) {
                addLog('Waiting for Supabase client...', 'info');
                
                if (window.configManager) {
                    try {
                        const isReady = await window.configManager.waitForSupabaseClient(5000);
                        if (!isReady) {
                            addLog('Supabase client not ready after timeout', 'error');
                            stopAnalysis();
                            return;
                        }
                    } catch (error) {
                        addLog(`Error waiting for Supabase client: ${error.message}`, 'error');
                        stopAnalysis();
                        return;
                    }
                }
            }
            
            // Setup auth listener
            setupAuthListener();
            
            // Check auth state periodically
            analysisInterval = setInterval(checkAuthState, 2000);
            
            // Initial check
            await checkAuthState();
            
            addLog('Analysis started - monitoring auth state changes...', 'success');
        }
        
        function stopAnalysis() {
            if (!analysisRunning) return;
            
            analysisRunning = false;
            
            document.getElementById('start-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
            
            if (authSubscription) {
                authSubscription.unsubscribe();
                authSubscription = null;
            }
            
            if (analysisInterval) {
                clearInterval(analysisInterval);
                analysisInterval = null;
            }
            
            addLog('Analysis stopped', 'info');
            
            // Generate findings
            generateFindings();
        }
        
        async function testLogin() {
            if (!window.authService) {
                addLog('AuthService not available', 'error');
                return;
            }
            
            addLog('Testing login...', 'info');
            
            try {
                const result = await window.authService.login('mukhsin9@gmail.com', 'password123');
                
                if (result.success) {
                    addLog(`Login successful: ${result.user.email}`, 'success');
                } else {
                    addLog(`Login failed: ${result.error}`, 'error');
                }
            } catch (error) {
                addLog(`Login test error: ${error.message}`, 'error');
            }
        }
        
        async function testLogout() {
            if (!window.authService) {
                addLog('AuthService not available', 'error');
                return;
            }
            
            addLog('Testing logout...', 'info');
            
            try {
                const result = await window.authService.logout();
                
                if (result.success) {
                    addLog('Logout successful', 'success');
                } else {
                    addLog(`Logout failed: ${result.error}`, 'error');
                }
            } catch (error) {
                addLog(`Logout test error: ${error.message}`, 'error');
            }
        }
        
        function generateFindings() {
            const findings = document.getElementById('findings');
            let html = '<h6>Analysis Results:</h6><ul>';
            
            if (authChangeCount === 0) {
                html += '<li class="text-info">No auth state changes detected - this is normal for a stable session</li>';
            } else if (authChangeCount <= 2) {
                html += '<li class="text-success">Normal auth state changes detected (login/logout)</li>';
            } else if (authChangeCount <= 5) {
                html += '<li class="text-warning">Multiple auth state changes detected - monitor for patterns</li>';
            } else {
                html += '<li class="text-danger">Excessive auth state changes detected - likely causing login loop</li>';
            }
            
            html += '</ul><h6>Recommendations:</h6><ul>';
            
            if (authChangeCount > 5) {
                html += '<li class="text-danger">CRITICAL: Fix multiple auth listeners or session conflicts</li>';
                html += '<li>Check for duplicate auth state listeners in app.js</li>';
                html += '<li>Verify session storage is not conflicting</li>';
                html += '<li>Check for automatic token refresh loops</li>';
            } else {
                html += '<li class="text-success">Auth behavior appears normal</li>';
            }
            
            html += '</ul>';
            findings.innerHTML = html;
        }
        
        // Auto-start analysis when page loads
        window.addEventListener('load', function() {
            setTimeout(() => {
                addLog('Page loaded, ready for analysis', 'info');
            }, 1000);
        });
        
        addLog('Login loop analysis tool loaded', 'info');
    </script>
</body>
</html>