<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test RS Display Fix</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/rencana-strategis-clean.css">
    <link rel="stylesheet" href="/css/rencana-strategis-fix-final.css">
    <style>
        body { background: #f8f9fa; padding: 20px; }
        .test-result { padding: 10px; margin: 5px 0; border-radius: 8px; }
        .test-pass { background: #d4edda; color: #155724; }
        .test-fail { background: #f8d7da; color: #721c24; }
        .test-info { background: #d1ecf1; color: #0c5460; }
        #test-container { margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4"><i class="fas fa-vial me-2"></i>Test RS Display Fix</h1>
        
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Test Controls</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-primary me-2" onclick="runAllTests()">
                    <i class="fas fa-play me-1"></i>Run All Tests
                </button>
                <button class="btn btn-success me-2" onclick="testCorrectDisplay()">
                    <i class="fas fa-check me-1"></i>Test Correct Display
                </button>
                <button class="btn btn-warning me-2" onclick="simulateSelectionList()">
                    <i class="fas fa-exclamation-triangle me-1"></i>Simulate Selection List
                </button>
                <button class="btn btn-info me-2" onclick="loadRSModule()">
                    <i class="fas fa-sync me-1"></i>Load RS Module
                </button>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>Test Results</h5>
            </div>
            <div class="card-body" id="test-results">
                <p class="text-muted">Click "Run All Tests" to start testing...</p>
            </div>
        </div>
        
        <!-- Simulated RS Page Container -->
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-desktop me-2"></i>RS Page Container (Simulated)</h5>
            </div>
            <div class="card-body p-0">
                <div id="rencana-strategis" class="page-content active" style="background: #f8f9fa;">
                    <div class="page-header p-3">
                        <h1 class="page-title"><i class="fas fa-chart-line me-2"></i>Rencana Strategis</h1>
                    </div>
                    <div id="rencana-strategis-content" style="min-height: 400px;">
                        <!-- Content will be loaded here -->
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-3 text-muted">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Mock API
        window.apiCall = async (endpoint, options = {}) => {
            console.log('API Call:', endpoint);
            
            if (endpoint.includes('/api/rencana-strategis/generate/kode')) {
                return { kode: 'RS-2026-001' };
            }
            
            if (endpoint.includes('/api/rencana-strategis')) {
                return [
                    { id: '1', kode: 'RS-2025-001', nama_rencana: 'Test Rencana 1', status: 'Aktif', target: 'Target 1' },
                    { id: '2', kode: 'RS-2025-002', nama_rencana: 'Test Rencana 2', status: 'Draft', target: 'Target 2' }
                ];
            }
            
            if (endpoint.includes('/api/visi-misi')) {
                return [
                    { id: '1', misi: '1. Misi pertama\n2. Misi kedua' }
                ];
            }
            
            return [];
        };
        
        // Test results
        const results = [];
        
        function addResult(name, passed, message) {
            results.push({ name, passed, message });
            updateResultsDisplay();
        }
        
        function updateResultsDisplay() {
            const container = document.getElementById('test-results');
            container.innerHTML = results.map(r => `
                <div class="test-result ${r.passed ? 'test-pass' : 'test-fail'}">
                    <strong>${r.passed ? '✅' : '❌'} ${r.name}</strong>
                    <p class="mb-0 small">${r.message}</p>
                </div>
            `).join('');
        }
        
        function testCorrectDisplay() {
            const container = document.getElementById('rencana-strategis-content');
            const html = container.innerHTML;
            
            const hasWrapper = html.includes('rencana-strategis-wrapper');
            const hasTable = container.querySelector('table') !== null;
            const hasForm = html.includes('rs-form') || html.includes('Form Input');
            const hasCards = html.includes('Rencana Aktif') || html.includes('Total Rencana');
            const hasSelectionList = html.includes('Pilih Rencana Strategis') && !hasTable;
            
            addResult('Has Wrapper', hasWrapper, hasWrapper ? 'Wrapper found' : 'Wrapper NOT found');
            addResult('Has Table', hasTable, hasTable ? 'Table found' : 'Table NOT found');
            addResult('Has Form', hasForm, hasForm ? 'Form found' : 'Form NOT found');
            addResult('Has Stat Cards', hasCards, hasCards ? 'Stat cards found' : 'Stat cards NOT found');
            addResult('No Selection List', !hasSelectionList, hasSelectionList ? 'Selection list FOUND (BAD!)' : 'No selection list (GOOD)');
            
            const isCorrect = hasWrapper && (hasTable || hasForm || hasCards) && !hasSelectionList;
            addResult('Overall Display', isCorrect, isCorrect ? 'Display is CORRECT!' : 'Display is INCORRECT!');
        }
        
        function simulateSelectionList() {
            const container = document.getElementById('rencana-strategis-content');
            
            // Simulate wrong display (selection list)
            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>Pilih Rencana Strategis</h3>
                    </div>
                    <div class="card-body">
                        <div class="list-group">
                            <a href="#" class="list-group-item">RS-2025-001 - Test Rencana 1</a>
                            <a href="#" class="list-group-item">RS-2025-002 - Test Rencana 2</a>
                        </div>
                    </div>
                </div>
            `;
            
            addResult('Simulated Selection List', true, 'Selection list injected - check if protection kicks in');
            
            // Wait and check if protection works
            setTimeout(() => {
                testCorrectDisplay();
            }, 2000);
        }
        
        async function loadRSModule() {
            addResult('Loading Module', true, 'Attempting to load RS module...');
            
            if (window.RencanaStrategisFast && typeof window.RencanaStrategisFast.load === 'function') {
                await window.RencanaStrategisFast.load();
                addResult('Module Loaded', true, 'RencanaStrategisFast loaded successfully');
            } else if (window.RencanaStrategisModule && typeof window.RencanaStrategisModule.load === 'function') {
                await window.RencanaStrategisModule.load();
                addResult('Module Loaded', true, 'RencanaStrategisModule loaded successfully');
            } else {
                addResult('Module Loaded', false, 'No RS module found!');
            }
            
            setTimeout(testCorrectDisplay, 500);
        }
        
        async function runAllTests() {
            results.length = 0;
            updateResultsDisplay();
            
            addResult('Test Started', true, 'Running all tests...');
            
            // Load module first
            await loadRSModule();
            
            // Wait for render
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Test correct display
            testCorrectDisplay();
            
            // Simulate selection list attack
            addResult('Protection Test', true, 'Simulating selection list injection...');
            simulateSelectionList();
        }
        
        // Auto-run on load
        window.addEventListener('load', () => {
            addResult('Page Loaded', true, 'Test page loaded successfully');
        });
    </script>
    
    <!-- Load RS Module -->
    <script src="/js/rencana-strategis-fast.js?v=1.2"></script>
    <script src="/js/rencana-strategis-display-guard.js?v=1.0"></script>
</body>
</html>
