<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisis SWOT - Comprehensive</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Enhanced SWOT Analysis Styles */
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 12px;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .btn-action {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        
        .btn-template {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .btn-import {
            background: linear-gradient(135deg, #17a2b8, #6f42c1);
            color: white;
        }
        
        .btn-add {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }
        
        .btn-report {
            background: linear-gradient(135deg, #fd7e14, #e63946);
            color: white;
        }
        
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* Filter Section */
        .filter-section {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 1px solid #cbd5e1;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            text-align: center;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--card-color);
        }
        
        .summary-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
        }
        
        .summary-card.strength { --card-color: #10b981; }
        .summary-card.weakness { --card-color: #ef4444; }
        .summary-card.opportunity { --card-color: #3b82f6; }
        .summary-card.threat { --card-color: #f59e0b; }
        
        .card-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem;
            background: var(--card-color);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .card-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--card-color);
            margin-bottom: 0.5rem;
            line-height: 1;
        }
        
        /* Table Styles */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .swot-table {
            min-width: 1400px;
            font-size: 0.875rem;
            margin: 0;
        }
        
        .swot-table th {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
            border: 1px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 12px 8px;
            color: #495057;
        }
        
        .swot-table td {
            vertical-align: middle;
            border: 1px solid #dee2e6;
            padding: 10px 8px;
        }
        
        /* Badge Styles - Fixed untuk tidak overflow */
        .badge-kategori {
            display: inline-block;
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 600;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 6px;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            box-sizing: border-box;
        }
        
        .badge-strength { 
            background-color: #10b981; 
            color: white;
        }
        
        .badge-weakness { 
            background-color: #ef4444; 
            color: white;
        }
        
        .badge-opportunity { 
            background-color: #3b82f6; 
            color: white;
        }
        
        .badge-threat { 
            background-color: #f59e0b; 
            color: #1e293b;
        }
        
        /* Column Styles */
        .kategori-column {
            width: 120px;
            min-width: 120px;
            max-width: 120px;
            text-align: center;
            padding: 8px 4px !important;
        }
        
        .kategori-column .badge-kategori {
            width: 100%;
            max-width: 110px;
        }
        
        .unit-kerja-column {
            width: 150px;
            max-width: 150px;
            word-wrap: break-word;
            font-weight: 500;
        }
        
        .rencana-strategis-column {
            width: 200px;
            max-width: 200px;
            word-wrap: break-word;
            font-size: 0.8rem;
        }
        
        .objek-analisis-column {
            width: 300px;
            max-width: 300px;
            word-wrap: break-word;
            line-height: 1.3;
        }
        
        .bobot-column, .rank-column, .score-column, .tahun-column {
            width: 80px;
            text-align: center;
            font-weight: 600;
        }
        
        .aksi-column {
            width: 100px;
            text-align: center;
        }
        
        /* Action Buttons */
        .btn-icon {
            padding: 6px 8px;
            margin: 0 2px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.75rem;
        }
        
        .btn-edit {
            background-color: #17a2b8;
            color: white;
        }
        
        .btn-delete {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 0;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .action-buttons {
                justify-content: center;
            }
            
            .kategori-column .badge-kategori {
                max-width: 90px;
                font-size: 10px;
                padding: 4px 8px;
            }
            
            .swot-table {
                font-size: 0.75rem;
            }
        }
        
        @media (max-width: 576px) {
            .kategori-column .badge-kategori {
                max-width: 80px;
                font-size: 9px;
                padding: 3px 6px;
            }
        }
        
        /* Loading and No Data States */
        .loading, .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .loading i, .no-data i {
            font-size: 1.5em;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Page Header -->
        <div class="page-header">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2 class="mb-1"><i data-lucide="bar-chart-3"></i> Analisis SWOT</h2>
                        <p class="mb-0 opacity-75">Analisis SWOT dengan fitur lengkap: template, import, export, dan manajemen data</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="action-buttons">
                            <button class="btn btn-action btn-template" onclick="downloadTemplate()">
                                <i class="fas fa-download"></i> Template
                            </button>
                            <button class="btn btn-action btn-import" onclick="showImportModal()">
                                <i class="fas fa-upload"></i> Import
                            </button>
                            <button class="btn btn-action btn-add" onclick="showAddModal()">
                                <i class="fas fa-plus"></i> Tambah
                            </button>
                            <button class="btn btn-action btn-report" onclick="downloadReport()">
                                <i class="fas fa-file-excel"></i> Laporan
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Unit Kerja</label>
                    <select id="filterUnitKerja" class="form-select" onchange="applyFilters()">
                        <option value="">Semua Unit Kerja</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Kategori</label>
                    <select id="filterKategori" class="form-select" onchange="applyFilters()">
                        <option value="">Semua Kategori</option>
                        <option value="Strength">Strength</option>
                        <option value="Weakness">Weakness</option>
                        <option value="Opportunity">Opportunity</option>
                        <option value="Threat">Threat</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Rencana Strategis</label>
                    <select id="filterRencanaStrategis" class="form-select" onchange="applyFilters()">
                        <option value="">Semua Rencana Strategis</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Tahun</label>
                    <select id="filterTahun" class="form-select" onchange="applyFilters()">
                        <option value="">Semua Tahun</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="summary-cards" id="summaryCards">
            <!-- Summary cards will be populated here -->
        </div>

        <!-- Data Table -->
        <div class="card border-0">
            <div class="card-header bg-transparent border-0">
                <h5 class="mb-0">Data Analisis SWOT</h5>
                <small class="text-muted">Kelola data analisis SWOT dengan fitur lengkap</small>
            </div>
            <div class="card-body p-0">
                <div class="table-container">
                    <table class="table table-striped swot-table" id="swotTable">
                        <thead>
                            <tr>
                                <th class="unit-kerja-column">Unit Kerja</th>
                                <th class="kategori-column">Kategori</th>
                                <th class="rencana-strategis-column">Rencana Strategis</th>
                                <th class="objek-analisis-column">Objek Analisis</th>
                                <th class="bobot-column">Bobot</th>
                                <th class="rank-column">Rank</th>
                                <th class="score-column">Score</th>
                                <th class="tahun-column">Tahun</th>
                                <th class="aksi-column">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="swotTableBody">
                            <tr>
                                <td colspan="9" class="loading">
                                    <i class="fas fa-spinner fa-spin"></i> Memuat data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Import Data SWOT</h3>
                <button class="modal-close" onclick="closeModal('importModal')">&times;</button>
            </div>
            <div style="padding: 1.5rem;">
                <div class="mb-3">
                    <label class="form-label">Pilih File Excel</label>
                    <input type="file" class="form-control" id="importFile" accept=".xlsx,.xls" onchange="handleFileSelect(event)">
                    <small class="text-muted">Format: .xlsx atau .xls. Gunakan template yang telah disediakan.</small>
                </div>
                <div class="d-flex gap-2 justify-content-end">
                    <button class="btn btn-secondary" onclick="closeModal('importModal')">Batal</button>
                    <button class="btn btn-primary" onclick="processImport()" id="importBtn" disabled>
                        <i class="fas fa-upload"></i> Import Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="dataModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Tambah Data SWOT</h3>
                <button class="modal-close" onclick="closeModal('dataModal')">&times;</button>
            </div>
            <form id="swotForm" onsubmit="saveData(event)">
                <div style="padding: 1.5rem;">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Unit Kerja *</label>
                                <select class="form-control" id="unitKerja" required>
                                    <option value="">Pilih Unit Kerja</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Kategori *</label>
                                <select class="form-control" id="kategori" required>
                                    <option value="">Pilih Kategori</option>
                                    <option value="Strength">Strength</option>
                                    <option value="Weakness">Weakness</option>
                                    <option value="Opportunity">Opportunity</option>
                                    <option value="Threat">Threat</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Rencana Strategis</label>
                        <select class="form-control" id="rencanaStrategis">
                            <option value="">Pilih Rencana Strategis (Opsional)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Objek Analisis *</label>
                        <textarea class="form-control" id="objekAnalisis" required rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Bobot (0-100) *</label>
                                <input type="number" class="form-control" id="bobot" required min="0" max="100">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Rank (1-5) *</label>
                                <input type="number" class="form-control" id="rank" required min="1" max="5">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Tahun *</label>
                                <input type="number" class="form-control" id="tahun" required value="2025">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="padding: 1rem 1.5rem; border-top: 1px solid #e2e8f0;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('dataModal')">Batal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allData = [];
        let filteredData = [];
        let unitKerjaList = [];
        let rencanaStrategisList = [];
        let currentEditId = null;

        // API Configuration
        const API_BASE_URL = window.location.origin;
        
        async function apiCall(endpoint, options = {}) {
            const token = localStorage.getItem('token');
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token ? `Bearer ${token}` : ''
                }
            };
            
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                ...defaultOptions,
                ...options,
                headers: { ...defaultOptions.headers, ...options.headers }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return await response.json();
        }

        async function loadInitialData() {
            try {
                console.log('Loading SWOT data...');
                
                // Load SWOT data with related data
                const swotData = await apiCall('/api/analisis-swot');
                console.log('SWOT data loaded:', swotData.length, 'items');
                
                // Load unit kerja
                const unitKerjaData = await apiCall('/api/master-data/work-units');
                unitKerjaList = unitKerjaData || [];
                
                // Load rencana strategis
                const rencanaStrategisData = await apiCall('/api/rencana-strategis');
                rencanaStrategisList = rencanaStrategisData || [];
                
                // Process and enhance data
                allData = swotData.map(item => ({
                    ...item,
                    unit_kerja_name: getUnitKerjaName(item.unit_kerja_id),
                    rencana_strategis_info: getRencanaStrategisInfo(item.rencana_strategis_id)
                }));
                
                filteredData = [...allData];
                
                populateFilters();
                populateFormOptions();
                renderSummaryCards();
                renderTable();
                
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Gagal memuat data: ' + error.message);
            }
        }

        function getUnitKerjaName(unitKerjaId) {
            if (!unitKerjaId) return 'Unknown Unit';
            const unit = unitKerjaList.find(u => u.id === unitKerjaId);
            return unit ? unit.name : 'Unknown Unit';
        }

        function getRencanaStrategisInfo(rencanaStrategisId) {
            if (!rencanaStrategisId) {
                return { kode: '-', nama: 'Tidak terkait' };
            }
            
            const rencana = rencanaStrategisList.find(r => r.id === rencanaStrategisId);
            return rencana ? {
                kode: rencana.kode,
                nama: rencana.nama_rencana
            } : {
                kode: '-',
                nama: 'Tidak ditemukan'
            };
        }

        function populateFilters() {
            // Populate Unit Kerja filter
            const unitKerjaSelect = document.getElementById('filterUnitKerja');
            unitKerjaSelect.innerHTML = '<option value="">Semua Unit Kerja</option>';
            
            const uniqueUnits = [...new Set(allData.map(item => item.unit_kerja_id).filter(Boolean))];
            uniqueUnits.forEach(unitId => {
                const unitName = getUnitKerjaName(unitId);
                unitKerjaSelect.innerHTML += `<option value="${unitId}">${unitName}</option>`;
            });

            // Populate Rencana Strategis filter
            const rencanaSelect = document.getElementById('filterRencanaStrategis');
            rencanaSelect.innerHTML = '<option value="">Semua Rencana Strategis</option>';
            
            rencanaStrategisList.forEach(rencana => {
                rencanaSelect.innerHTML += `<option value="${rencana.id}">${rencana.kode} - ${rencana.nama_rencana}</option>`;
            });
        }

        function populateFormOptions() {
            // Populate Unit Kerja in form
            const unitKerjaForm = document.getElementById('unitKerja');
            unitKerjaForm.innerHTML = '<option value="">Pilih Unit Kerja</option>';
            unitKerjaList.forEach(unit => {
                unitKerjaForm.innerHTML += `<option value="${unit.id}">${unit.name}</option>`;
            });

            // Populate Rencana Strategis in form
            const rencanaForm = document.getElementById('rencanaStrategis');
            rencanaForm.innerHTML = '<option value="">Pilih Rencana Strategis (Opsional)</option>';
            rencanaStrategisList.forEach(rencana => {
                rencanaForm.innerHTML += `<option value="${rencana.id}">${rencana.kode} - ${rencana.nama_rencana}</option>`;
            });
        }

        function applyFilters() {
            const unitKerjaFilter = document.getElementById('filterUnitKerja').value;
            const kategoriFilter = document.getElementById('filterKategori').value;
            const rencanaFilter = document.getElementById('filterRencanaStrategis').value;
            const tahunFilter = document.getElementById('filterTahun').value;

            filteredData = allData.filter(item => {
                return (!unitKerjaFilter || item.unit_kerja_id === unitKerjaFilter) &&
                       (!kategoriFilter || item.kategori === kategoriFilter) &&
                       (!rencanaFilter || item.rencana_strategis_id === rencanaFilter) &&
                       (!tahunFilter || item.tahun.toString() === tahunFilter);
            });

            renderSummaryCards();
            renderTable();
        }

        function renderSummaryCards() {
            const summaryContainer = document.getElementById('summaryCards');
            
            // Calculate summary by category
            const summary = {
                Strength: { count: 0, totalScore: 0, totalBobot: 0 },
                Weakness: { count: 0, totalScore: 0, totalBobot: 0 },
                Opportunity: { count: 0, totalScore: 0, totalBobot: 0 },
                Threat: { count: 0, totalScore: 0, totalBobot: 0 }
            };

            filteredData.forEach(item => {
                if (summary[item.kategori]) {
                    summary[item.kategori].count++;
                    summary[item.kategori].totalScore += item.score || 0;
                    summary[item.kategori].totalBobot += item.bobot || 0;
                }
            });

            const cardConfig = {
                Strength: { 
                    icon: 'trending-up', 
                    class: 'strength',
                    title: 'Kekuatan'
                },
                Weakness: { 
                    icon: 'trending-down', 
                    class: 'weakness',
                    title: 'Kelemahan'
                },
                Opportunity: { 
                    icon: 'lightbulb', 
                    class: 'opportunity',
                    title: 'Peluang'
                },
                Threat: { 
                    icon: 'alert-triangle', 
                    class: 'threat',
                    title: 'Ancaman'
                }
            };

            summaryContainer.innerHTML = Object.keys(summary).map(category => {
                const config = cardConfig[category];
                const data = summary[category];
                
                // Ensure proper score calculation
                const totalScore = data.totalScore || 0;
                
                return `
                    <div class="summary-card ${config.class}">
                        <div class="card-icon">
                            <i data-lucide="${config.icon}"></i>
                        </div>
                        <div class="card-title">${config.title}</div>
                        <div class="card-value">${totalScore}</div>
                        <div class="card-subtitle">Total Score</div>
                        <div class="card-stats">
                            <div class="card-stat">
                                <div class="card-stat-label">Items</div>
                                <div class="card-stat-value">${data.count}</div>
                            </div>
                            <div class="card-stat">
                                <div class="card-stat-label">Bobot</div>
                                <div class="card-stat-value">${data.totalBobot}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function renderTable() {
            const tbody = document.getElementById('swotTableBody');
            
            if (filteredData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="no-data">
                            <i class="fas fa-info-circle"></i> Tidak ada data yang sesuai dengan filter
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredData.map(item => `
                <tr>
                    <td class="unit-kerja-column">${item.unit_kerja_name}</td>
                    <td class="kategori-column">
                        <span class="badge-kategori badge-${item.kategori.toLowerCase()}">${item.kategori}</span>
                    </td>
                    <td class="rencana-strategis-column">
                        <div class="kode" style="font-weight: 600; color: #495057; margin-bottom: 2px;">${item.rencana_strategis_info.kode}</div>
                        <div class="nama" style="color: #6c757d; font-size: 0.85em; line-height: 1.2;">${item.rencana_strategis_info.nama}</div>
                    </td>
                    <td class="objek-analisis-column">${item.objek_analisis}</td>
                    <td class="bobot-column">${item.bobot}</td>
                    <td class="rank-column">${item.rank}</td>
                    <td class="score-column">${item.score}</td>
                    <td class="tahun-column">${item.tahun}</td>
                    <td class="aksi-column">
                        <button class="btn-icon btn-edit" onclick="editData('${item.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon btn-delete" onclick="deleteData('${item.id}')" title="Hapus">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function showError(message) {
            const tbody = document.getElementById('swotTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle"></i> ${message}
                    </td>
                </tr>
            `;
        }

        // Modal Functions
        function showImportModal() {
            document.getElementById('importModal').classList.add('active');
        }

        function showAddModal() {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = 'Tambah Data SWOT';
            document.getElementById('swotForm').reset();
            document.getElementById('dataModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // File handling
        function handleFileSelect(event) {
            const file = event.target.files[0];
            const importBtn = document.getElementById('importBtn');
            
            if (file) {
                importBtn.disabled = false;
            } else {
                importBtn.disabled = true;
            }
        }

        // Template download
        function downloadTemplate() {
            const templateData = [
                {
                    'Unit Kerja': 'Contoh Unit Kerja',
                    'Kategori': 'Strength',
                    'Rencana Strategis': 'RS-001',
                    'Objek Analisis': 'Contoh objek analisis SWOT',
                    'Bobot': 20,
                    'Rank': 4,
                    'Tahun': 2025
                }
            ];

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(templateData);
            
            // Set column widths
            ws['!cols'] = [
                { wch: 20 }, // Unit Kerja
                { wch: 15 }, // Kategori
                { wch: 20 }, // Rencana Strategis
                { wch: 40 }, // Objek Analisis
                { wch: 10 }, // Bobot
                { wch: 10 }, // Rank
                { wch: 10 }  // Tahun
            ];

            XLSX.utils.book_append_sheet(wb, ws, 'Template SWOT');
            XLSX.writeFile(wb, 'Template_Analisis_SWOT.xlsx');
        }

        // Report download
        function downloadReport() {
            if (filteredData.length === 0) {
                alert('Tidak ada data untuk diunduh');
                return;
            }

            const reportData = filteredData.map((item, index) => ({
                'No': index + 1,
                'Unit Kerja': item.unit_kerja_name,
                'Kategori': item.kategori,
                'Rencana Strategis': `${item.rencana_strategis_info.kode} - ${item.rencana_strategis_info.nama}`,
                'Objek Analisis': item.objek_analisis,
                'Bobot': item.bobot,
                'Rank': item.rank,
                'Score': item.score,
                'Tahun': item.tahun,
                'Tanggal Dibuat': new Date(item.created_at).toLocaleDateString('id-ID')
            }));

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(reportData);

            // Set column widths
            ws['!cols'] = [
                { wch: 5 },  // No
                { wch: 20 }, // Unit Kerja
                { wch: 15 }, // Kategori
                { wch: 30 }, // Rencana Strategis
                { wch: 40 }, // Objek Analisis
                { wch: 10 }, // Bobot
                { wch: 10 }, // Rank
                { wch: 10 }, // Score
                { wch: 10 }, // Tahun
                { wch: 15 }  // Tanggal Dibuat
            ];

            XLSX.utils.book_append_sheet(wb, ws, 'Laporan SWOT');
            
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            XLSX.writeFile(wb, `Laporan_Analisis_SWOT_${timestamp}.xlsx`);
        }

        // Data operations
        async function saveData(event) {
            event.preventDefault();
            
            try {
                const formData = {
                    unit_kerja_id: document.getElementById('unitKerja').value,
                    kategori: document.getElementById('kategori').value,
                    rencana_strategis_id: document.getElementById('rencanaStrategis').value || null,
                    objek_analisis: document.getElementById('objekAnalisis').value,
                    bobot: parseInt(document.getElementById('bobot').value),
                    rank: parseInt(document.getElementById('rank').value),
                    tahun: parseInt(document.getElementById('tahun').value)
                };

                if (currentEditId) {
                    await apiCall(`/api/analisis-swot/${currentEditId}`, {
                        method: 'PUT',
                        body: JSON.stringify(formData)
                    });
                } else {
                    await apiCall('/api/analisis-swot', {
                        method: 'POST',
                        body: JSON.stringify(formData)
                    });
                }

                closeModal('dataModal');
                await loadInitialData();
                alert('Data berhasil disimpan');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function editData(id) {
            try {
                const data = await apiCall(`/api/analisis-swot/${id}`);
                
                currentEditId = id;
                document.getElementById('modalTitle').textContent = 'Edit Data SWOT';
                document.getElementById('unitKerja').value = data.unit_kerja_id || '';
                document.getElementById('kategori').value = data.kategori || '';
                document.getElementById('rencanaStrategis').value = data.rencana_strategis_id || '';
                document.getElementById('objekAnalisis').value = data.objek_analisis || '';
                document.getElementById('bobot').value = data.bobot || '';
                document.getElementById('rank').value = data.rank || '';
                document.getElementById('tahun').value = data.tahun || '';
                
                document.getElementById('dataModal').classList.add('active');
            } catch (error) {
                alert('Error loading data: ' + error.message);
            }
        }

        async function deleteData(id) {
            if (!confirm('Yakin ingin menghapus data ini?')) return;
            
            try {
                await apiCall(`/api/analisis-swot/${id}`, { method: 'DELETE' });
                await loadInitialData();
                alert('Data berhasil dihapus');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function processImport() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Pilih file terlebih dahulu');
                return;
            }

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                // Process and validate data
                const processedData = jsonData.map(row => ({
                    unit_kerja_id: findUnitKerjaId(row['Unit Kerja']),
                    kategori: row['Kategori'],
                    rencana_strategis_id: findRencanaStrategisId(row['Rencana Strategis']),
                    objek_analisis: row['Objek Analisis'],
                    bobot: parseInt(row['Bobot']),
                    rank: parseInt(row['Rank']),
                    tahun: parseInt(row['Tahun'])
                }));

                // Import data
                for (const item of processedData) {
                    await apiCall('/api/analisis-swot', {
                        method: 'POST',
                        body: JSON.stringify(item)
                    });
                }

                closeModal('importModal');
                await loadInitialData();
                alert(`Berhasil mengimport ${processedData.length} data`);
            } catch (error) {
                alert('Error importing data: ' + error.message);
            }
        }

        function findUnitKerjaId(unitName) {
            const unit = unitKerjaList.find(u => u.name === unitName);
            return unit ? unit.id : null;
        }

        function findRencanaStrategisId(rencanaCode) {
            const rencana = rencanaStrategisList.find(r => r.kode === rencanaCode);
            return rencana ? rencana.id : null;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing SWOT Analisis...');
            
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            loadInitialData();
        });
    </script>
</body>
</html>