<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test PDF & View Button Fix</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background: #f5f5f5; }
        .test-card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-pending { background: #fff3cd; color: #856404; }
        .log-area { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .log-success { color: #4ec9b0; }
        .log-error { color: #f14c4c; }
        .log-info { color: #569cd6; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4"><i class="fas fa-file-pdf text-danger"></i> Test PDF & View Button Fix</h1>
        
        <div class="test-card">
            <h4>Test Status</h4>
            <div id="test-status" class="mb-3">
                <span class="status-badge status-pending">Menunggu...</span>
            </div>
            <button class="btn btn-primary me-2" onclick="runAllTests()"><i class="fas fa-play"></i> Run All Tests</button>
            <button class="btn btn-secondary" onclick="clearLogs()"><i class="fas fa-trash"></i> Clear Logs</button>
        </div>

        <div class="test-card">
            <h4>PDF Endpoint Tests</h4>
            <div class="row g-2 mb-3">
                <div class="col-auto"><button class="btn btn-outline-danger btn-sm" onclick="testPDFEndpoint('risk-register')">Risk Register PDF</button></div>
                <div class="col-auto"><button class="btn btn-outline-danger btn-sm" onclick="testPDFEndpoint('risk-profile')">Risk Profile PDF</button></div>
                <div class="col-auto"><button class="btn btn-outline-danger btn-sm" onclick="testPDFEndpoint('residual-risk')">Residual Risk PDF</button></div>
                <div class="col-auto"><button class="btn btn-outline-danger btn-sm" onclick="testPDFEndpoint('risk-appetite')">Risk Appetite PDF</button></div>
                <div class="col-auto"><button class="btn btn-outline-danger btn-sm" onclick="testPDFEndpoint('kri')">KRI PDF</button></div>
                <div class="col-auto"><button class="btn btn-outline-danger btn-sm" onclick="testPDFEndpoint('monitoring')">Monitoring PDF</button></div>
                <div class="col-auto"><button class="btn btn-outline-danger btn-sm" onclick="testPDFEndpoint('loss-event')">Loss Event PDF</button></div>
                <div class="col-auto"><button class="btn btn-outline-danger btn-sm" onclick="testPDFEndpoint('strategic-map')">Strategic Map PDF</button></div>
            </div>
        </div>

        <div class="test-card">
            <h4>View/Preview Endpoint Tests</h4>
            <div class="row g-2 mb-3">
                <div class="col-auto"><button class="btn btn-outline-info btn-sm" onclick="testViewEndpoint('risk-register')">Risk Register View</button></div>
                <div class="col-auto"><button class="btn btn-outline-info btn-sm" onclick="testViewEndpoint('risk-profile')">Risk Profile View</button></div>
                <div class="col-auto"><button class="btn btn-outline-info btn-sm" onclick="testViewEndpoint('residual-risk')">Residual Risk View</button></div>
            </div>
        </div>

        <div class="test-card">
            <h4>Test Logs</h4>
            <div id="log-area" class="log-area"></div>
        </div>
    </div>

    <script>
        const logArea = document.getElementById('log-area');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'log-success' : type === 'error' ? 'log-error' : 'log-info';
            logArea.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLogs() {
            logArea.innerHTML = '';
        }

        function updateStatus(status, message) {
            const statusEl = document.getElementById('test-status');
            const className = status === 'success' ? 'status-success' : status === 'error' ? 'status-error' : 'status-pending';
            statusEl.innerHTML = `<span class="status-badge ${className}">${message}</span>`;
        }

        async function getAuthToken() {
            // Try to get token from localStorage
            let token = localStorage.getItem('authToken') || localStorage.getItem('supabase.auth.token');
            if (token) return token;
            
            // Try login for testing
            try {
                log('Attempting login for testing...', 'info');
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: 'admin@example.com', password: 'admin123' })
                });
                const data = await response.json();
                if (data.token) {
                    localStorage.setItem('authToken', data.token);
                    log('Login successful, token obtained', 'success');
                    return data.token;
                }
            } catch (e) {
                log('Login failed: ' + e.message, 'error');
            }
            return null;
        }

        async function testPDFEndpoint(reportId) {
            log(`Testing PDF endpoint: ${reportId}...`, 'info');
            
            try {
                const token = await getAuthToken();
                const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
                
                const response = await fetch(`/api/reports/${reportId}/pdf`, { headers });
                const contentType = response.headers.get('content-type') || '';
                
                if (response.ok && contentType.includes('pdf')) {
                    const blob = await response.blob();
                    log(`✅ ${reportId} PDF: Success! Size: ${blob.size} bytes`, 'success');
                    return true;
                } else if (response.status === 501) {
                    const data = await response.json();
                    log(`⚠️ ${reportId} PDF: Not implemented - ${data.message}`, 'error');
                    return false;
                } else {
                    const text = await response.text();
                    log(`❌ ${reportId} PDF: Failed (${response.status}) - ${text.substring(0, 100)}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`❌ ${reportId} PDF: Error - ${error.message}`, 'error');
                return false;
            }
        }

        async function testViewEndpoint(reportId) {
            log(`Testing View endpoint: ${reportId}...`, 'info');
            
            const endpointMap = {
                'risk-register': '/api/reports/risk-register',
                'risk-profile': '/api/reports/risk-profile',
                'residual-risk': '/api/reports/residual-risk'
            };
            
            try {
                const token = await getAuthToken();
                const headers = { 'Content-Type': 'application/json' };
                if (token) headers['Authorization'] = `Bearer ${token}`;
                
                const response = await fetch(endpointMap[reportId], { headers });
                
                if (response.ok) {
                    const data = await response.json();
                    const count = Array.isArray(data) ? data.length : (data.recordCount || 1);
                    log(`✅ ${reportId} View: Success! Records: ${count}`, 'success');
                    return true;
                } else {
                    const text = await response.text();
                    log(`❌ ${reportId} View: Failed (${response.status}) - ${text.substring(0, 100)}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`❌ ${reportId} View: Error - ${error.message}`, 'error');
                return false;
            }
        }

        async function runAllTests() {
            clearLogs();
            updateStatus('pending', 'Running tests...');
            log('Starting all tests...', 'info');
            
            let passed = 0;
            let failed = 0;
            
            // Test PDF endpoints
            const pdfEndpoints = ['risk-register', 'risk-profile', 'residual-risk', 'risk-appetite', 'kri', 'monitoring', 'loss-event', 'strategic-map'];
            for (const endpoint of pdfEndpoints) {
                const result = await testPDFEndpoint(endpoint);
                if (result) passed++; else failed++;
                await new Promise(r => setTimeout(r, 500)); // Small delay between tests
            }
            
            // Test View endpoints
            const viewEndpoints = ['risk-register', 'risk-profile', 'residual-risk'];
            for (const endpoint of viewEndpoints) {
                const result = await testViewEndpoint(endpoint);
                if (result) passed++; else failed++;
                await new Promise(r => setTimeout(r, 500));
            }
            
            log(`\n=== Test Summary ===`, 'info');
            log(`Passed: ${passed}`, 'success');
            log(`Failed: ${failed}`, failed > 0 ? 'error' : 'info');
            
            if (failed === 0) {
                updateStatus('success', `All ${passed} tests passed!`);
            } else {
                updateStatus('error', `${passed} passed, ${failed} failed`);
            }
        }
    </script>
</body>
</html>
