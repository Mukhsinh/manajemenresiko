// Sasaran Strategi Module
const SasaranStrategiModule = (() => {
  const state = {
    data: [],
    rencanaStrategis: [],
    towsStrategi: [],
    filters: {
      rencana_strategis_id: '',
      tows_strategi_id: '',
      perspektif: ''
    }
  };

  const api = () => (window.app ? window.app.apiCall : window.apiCall);

  async function load() {
    await fetchInitialData();
    render();
  }

  async function fetchInitialData() {
    try {
      console.log('=== FETCHING SASARAN STRATEGI DATA ===');
      console.log('Current filters:', state.filters);
      
      const apiUrl = '/api/sasaran-strategi?' + new URLSearchParams(state.filters);
      console.log('API URL:', apiUrl);
      
      let sasaran, rencana, tows;
      
      try {
        // Try authenticated endpoints first
        [sasaran, rencana, tows] = await Promise.all([
          api()(apiUrl),
          api()('/api/rencana-strategis'),
          api()('/api/matriks-tows')
        ]);
        console.log('Authenticated API success');
      } catch (authError) {
        console.warn('Authenticated API failed, trying fallback endpoints:', authError.message);
        
        // Fallback to simple/debug endpoints
        try {
          [sasaran, rencana, tows] = await Promise.all([
            api()('/api/sasaran-strategi/simple').catch(() => 
              api()('/api/sasaran-strategi/debug').then(res => res.data || [])
            ),
            api()('/api/rencana-strategis/simple').catch(() => []),
            api()('/api/matriks-tows/simple').catch(() => [])
          ]);
          console.log('Fallback API success');
        } catch (fallbackError) {
          console.error('All APIs failed:', fallbackError.message);
          throw new Error('Tidak dapat memuat data. Silakan refresh halaman atau hubungi administrator.');
        }
      }
      
      console.log('API responses:', {
        sasaran: { count: sasaran?.length || 0, isArray: Array.isArray(sasaran) },
        rencana: { count: rencana?.length || 0, isArray: Array.isArray(rencana) },
        tows: { count: tows?.length || 0, isArray: Array.isArray(tows) }
      });
      
      state.data = sasaran || [];
      state.rencanaStrategis = rencana || [];
      state.towsStrategi = tows || [];
      
      console.log('State updated:', {
        dataCount: state.data.length,
        rencanaCount: state.rencanaStrategis.length,
        towsCount: state.towsStrategi.length
      });
      console.log('=== END FETCH ===');
    } catch (error) {
      console.error('Error fetching data:', error);
      console.error('Error details:', {
        message: error.message,
        stack: error.stack
      });
      state.data = [];
      state.rencanaStrategis = [];
      state.towsStrategi = [];
      
      // Show error message in UI
      const container = document.getElementById('sasaran-strategi-content');
      if (container) {
        container.innerHTML = `
          <div class="card">
            <div class="card-body">
              <h5 class="text-danger"><i class="fas fa-exclamation-triangle"></i> Error memuat data</h5>
              <p>${error.message}</p>
              <button onclick="SasaranStrategiModule.load()" class="btn btn-primary">Coba Lagi</button>
            </div>
          </div>
        `;
      }
    }
  }

  /**
   * Renders the Sasaran Strategi page with enhanced HTML content
   * @returns {Promise<void>}
   */
  async function render() {
    /** @type {HTMLElement | null} */
    const container = document.getElementById('sasaran-strategi-content');
    if (!container) return;

    // Try to load enhanced HTML content first
    try {
      /** @type {Response} */
      const response = await fetch('/sasaran-strategi-enhanced-final.html');
      if (response.ok) {
        /** @type {string} */
        const htmlContent = await response.text();
        /** @type {DOMParser} */
        const parser = new DOMParser();
        /** @type {Document} */
        const doc = parser.parseFromString(htmlContent, 'text/html');
        
        // Extract styles from <style> tag in head
        /** @type {HTMLStyleElement | null} */
        const styleElement = doc.querySelector('head style');
        if (styleElement) {
          const styleId = 'sasaran-strategi-enhanced-styles';
          /** @type {HTMLElement | null} */
          const existingStyle = document.getElementById(styleId);
          if (existingStyle) {
            existingStyle.remove();
          }
          
          /** @type {HTMLStyleElement} */
          const newStyle = document.createElement('style');
          newStyle.id = styleId;
          newStyle.textContent = styleElement.textContent;
          document.head.appendChild(newStyle);
          console.log('✓ Enhanced styles loaded for Sasaran Strategi');
        }
        
        // Extract body content from .container-fluid
        /** @type {HTMLElement | null} */
        const containerFluid = doc.querySelector('.container-fluid');
        if (containerFluid) {
          container.innerHTML = containerFluid.innerHTML;
          console.log('✓ Enhanced HTML content loaded for Sasaran Strategi');
          
          // After loading enhanced HTML, populate filters and table data
          // Update filter dropdowns with actual data
          /** @type {HTMLSelectElement | null} */
          const rencanaSelect = container.querySelector('#filter-rencana-strategis, #filter-rencana');
          if (rencanaSelect) {
            // Clear existing options except "Semua"
            const allOption = rencanaSelect.querySelector('option[value=""]');
            rencanaSelect.innerHTML = '';
            if (allOption) rencanaSelect.appendChild(allOption);
            else {
              const defaultOption = document.createElement('option');
              defaultOption.value = '';
              defaultOption.textContent = 'Semua';
              rencanaSelect.appendChild(defaultOption);
            }
            
            state.rencanaStrategis.forEach(r => {
              /** @type {HTMLOptionElement} */
              const option = document.createElement('option');
              option.value = r.id;
              option.textContent = r.nama_rencana;
              if (state.filters.rencana_strategis_id === r.id) option.selected = true;
              rencanaSelect.appendChild(option);
            });
          }
          
          /** @type {HTMLSelectElement | null} */
          const towsSelect = container.querySelector('#filter-tows-strategi, #filter-tows');
          if (towsSelect) {
            // Clear existing options except "Semua"
            const allOption = towsSelect.querySelector('option[value=""]');
            towsSelect.innerHTML = '';
            if (allOption) towsSelect.appendChild(allOption);
            else {
              const defaultOption = document.createElement('option');
              defaultOption.value = '';
              defaultOption.textContent = 'Semua';
              towsSelect.appendChild(defaultOption);
            }
            
            state.towsStrategi.forEach(t => {
              /** @type {HTMLOptionElement} */
              const option = document.createElement('option');
              option.value = t.id;
              option.textContent = `${t.tipe_strategi}: ${t.strategi.length > 40 ? t.strategi.substring(0, 40) + '...' : t.strategi}`;
              option.title = t.strategi;
              if (state.filters.tows_strategi_id === t.id) option.selected = true;
              towsSelect.appendChild(option);
            });
          }
          
          /** @type {HTMLSelectElement | null} */
          const perspektifSelect = container.querySelector('#filter-perspektif');
          if (perspektifSelect && state.filters.perspektif) {
            perspektifSelect.value = state.filters.perspektif;
          }
          
          // Render table data
          renderTableIntoEnhancedHTML(container);
          
          // Attach event listeners for filters
          if (rencanaSelect) {
            rencanaSelect.onchange = () => SasaranStrategiModule.applyFilter();
          }
          if (towsSelect) {
            towsSelect.onchange = () => SasaranStrategiModule.applyFilter();
          }
          if (perspektifSelect) {
            perspektifSelect.onchange = () => SasaranStrategiModule.applyFilter();
          }
          
          return; // Exit early if enhanced HTML loaded successfully
        }
      }
    } catch (error) {
      /** @type {Error} */
      const err = error instanceof Error ? error : new Error(String(error));
      console.warn('⚠️ Could not load enhanced HTML, using inline rendering:', err);
    }

    // Fallback: Add enhanced CSS for perspektif badge fix
    const styleId = 'sasaran-strategi-enhanced-styles';
    const existingStyle = document.getElementById(styleId);
    if (!existingStyle) {
      const style = document.createElement('style');
      style.id = styleId;
      style.textContent = `
        /* FIXED: Perspektif Column - Badge Container with proper constraints */
        .perspektif-column {
          width: 150px;
          min-width: 150px;
          max-width: 150px;
          text-align: center;
          padding: 8px 4px !important;
          vertical-align: middle;
        }
        
        /* FIXED: Perspektif Badge - Properly contained within column */
        .badge-perspektif {
          display: inline-block;
          padding: 6px 8px;
          font-size: 10px;
          font-weight: 600;
          line-height: 1.2;
          text-align: center;
          white-space: nowrap;
          vertical-align: baseline;
          border-radius: 6px;
          max-width: 100%;
          width: 100%;
          box-sizing: border-box;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        
        .table-container {
          overflow-x: auto;
          max-width: 100%;
          width: 100%;
          box-sizing: border-box;
        }
        
        .sasaran-table {
          table-layout: fixed;
          min-width: 1200px;
          width: 100%;
        }
        
        .sasaran-table td {
          word-wrap: break-word;
          overflow-wrap: break-word;
          max-width: 0;
        }
        
        .sasaran-table .sasaran-column {
          word-wrap: break-word;
          overflow-wrap: break-word;
        }
        
        .card-body {
          overflow-x: hidden;
          overflow-y: visible;
        }
        
        .modal-content {
          max-width: 90vw;
          max-height: 90vh;
          overflow-y: auto;
          overflow-x: hidden;
        }
        
        .form-control, .form-select {
          max-width: 100%;
          box-sizing: border-box;
        }
        
        .filter-group {
          max-width: 100%;
          box-sizing: border-box;
        }
      `;
      document.head.appendChild(style);
    }

    container.innerHTML = `
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Sasaran Strategi</h3>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-info" onclick="SasaranStrategiModule.autoCorrelate()" title="Korelasikan otomatis dengan TOWS Strategi menggunakan AI">
              <i class="fas fa-magic"></i> Auto Korelasi AI
            </button>
            <button class="btn btn-success" onclick="SasaranStrategiModule.downloadReport()">
              <i class="fas fa-download"></i> Unduh Laporan
            </button>
            <button class="btn btn-primary" onclick="SasaranStrategiModule.showModal()">
              <i class="fas fa-plus"></i> Tambah Sasaran
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="filter-group" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
            <div class="form-group">
              <label>Rencana Strategis</label>
              <select class="form-control" id="filter-rencana-strategis" onchange="SasaranStrategiModule.applyFilter()">
                <option value="">Semua</option>
                ${state.rencanaStrategis.map(r => `<option value="${r.id}" ${state.filters.rencana_strategis_id === r.id ? 'selected' : ''}>${r.nama_rencana}</option>`).join('')}
              </select>
            </div>
            <div class="form-group">
              <label>TOWS Strategi</label>
              <select class="form-control" id="filter-tows-strategi" onchange="SasaranStrategiModule.applyFilter()">
                <option value="">Semua</option>
                ${state.towsStrategi.map(t => `
                  <option value="${t.id}" ${state.filters.tows_strategi_id === t.id ? 'selected' : ''} title="${t.strategi}">
                    ${t.tipe_strategi}: ${t.strategi.length > 40 ? t.strategi.substring(0, 40) + '...' : t.strategi}
                  </option>
                `).join('')}
              </select>
            </div>
            <div class="form-group">
              <label>Perspektif</label>
              <select class="form-control" id="filter-perspektif" onchange="SasaranStrategiModule.applyFilter()">
                <option value="">Semua</option>
                <option value="ES" ${state.filters.perspektif === 'ES' ? 'selected' : ''}>ES (Eksternal Stakeholder)</option>
                <option value="IBP" ${state.filters.perspektif === 'IBP' ? 'selected' : ''}>IBP (Internal Business Process)</option>
                <option value="LG" ${state.filters.perspektif === 'LG' ? 'selected' : ''}>LG (Learning & Growth)</option>
                <option value="Fin" ${state.filters.perspektif === 'Fin' ? 'selected' : ''}>Fin (Financial)</option>
              </select>
            </div>
          </div>
          <div class="table-container">
            <table class="table sasaran-table">
              <thead>
                <tr>
                  <th style="width: 20%; min-width: 150px;">Rencana Strategis</th>
                  <th style="width: 30%; min-width: 200px;">Sasaran</th>
                  <th class="perspektif-column">Perspektif</th>
                  <th style="width: 25%; min-width: 200px;">TOWS Strategi</th>
                  <th style="width: 10%; min-width: 80px;">Aksi</th>
                </tr>
              </thead>
              <tbody>
                ${state.data.length === 0 ? '<tr><td colspan="5" class="text-center">Tidak ada data</td></tr>' : ''}
                ${state.data.map(item => `
                  <tr>
                    <td>${item.rencana_strategis?.nama_rencana || '-'}</td>
                    <td>${item.sasaran}</td>
                    <td class="perspektif-column">
                      ${item.perspektif ? `
                        <span class="badge-perspektif badge-${item.perspektif.toLowerCase()}" style="
                          ${getBadgeStyle(getPerspektifColor(item.perspektif))}
                        ">
                          ${getPerspektifLabel(item.perspektif)}
                        </span>
                      ` : '<span style="color: #999; font-style: italic;">Tidak ada perspektif</span>'}
                    </td>
                    <td>
                      ${item.swot_tows_strategi ? 
                        `<div style="max-width: 300px;">
                          <span class="badge" style="
                            display: inline-block;
                            padding: 0.2rem 0.4rem;
                            font-size: 0.7rem;
                            font-weight: 600;
                            border-radius: 0.2rem;
                            margin-bottom: 0.25rem;
                            ${getTowsBadgeStyle(item.swot_tows_strategi.tipe_strategi)}
                          ">${item.swot_tows_strategi.tipe_strategi}</span><br>
                          <small style="color: #666; line-height: 1.3;">
                            ${item.swot_tows_strategi.strategi.length > 80 ? 
                              item.swot_tows_strategi.strategi.substring(0, 80) + '...' : 
                              item.swot_tows_strategi.strategi}
                          </small>
                        </div>` : 
                        '<span style="color: #999; font-style: italic;">Tidak terkait TOWS</span>'
                      }
                    </td>
                    <td>
                      <button class="btn btn-edit btn-sm" onclick="SasaranStrategiModule.edit('${item.id}')" title="Edit">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn btn-delete btn-sm" onclick="SasaranStrategiModule.delete('${item.id}')" title="Hapus">
                        <i class="fas fa-trash"></i>
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    `;
  }

  /**
   * Renders table data into enhanced HTML container
   * @param {HTMLElement} container - The container element
   * @returns {void}
   */
  function renderTableIntoEnhancedHTML(container) {
    /** @type {HTMLTableSectionElement | null} */
    const tbody = container.querySelector('#sasaranTableBody, .sasaran-table tbody, tbody');
    if (!tbody) {
      console.warn('Table body not found in enhanced HTML');
      return;
    }
    
    if (state.data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-center">Tidak ada data</td></tr>';
      return;
    }
    
    tbody.innerHTML = state.data.map(item => `
      <tr>
        <td>${item.rencana_strategis?.nama_rencana || '-'}</td>
        <td>${item.sasaran}</td>
        <td class="perspektif-column">
          ${item.perspektif ? `
            <span class="badge-perspektif badge-${item.perspektif.toLowerCase()}" style="${getBadgeStyle(getPerspektifColor(item.perspektif))}">
              ${getPerspektifLabel(item.perspektif)}
            </span>
          ` : '<span style="color: #999; font-style: italic;">Tidak ada perspektif</span>'}
        </td>
        <td>
          ${item.swot_tows_strategi ? 
            `<div style="max-width: 300px;">
              <span class="badge" style="display: inline-block; padding: 0.2rem 0.4rem; font-size: 0.7rem; font-weight: 600; border-radius: 0.2rem; margin-bottom: 0.25rem; ${getTowsBadgeStyle(item.swot_tows_strategi.tipe_strategi)}">${item.swot_tows_strategi.tipe_strategi}</span><br>
              <small style="color: #666; line-height: 1.3;">${item.swot_tows_strategi.strategi.length > 80 ? item.swot_tows_strategi.strategi.substring(0, 80) + '...' : item.swot_tows_strategi.strategi}</small>
            </div>` : 
            '<span style="color: #999; font-style: italic;">Tidak terkait TOWS</span>'
          }
        </td>
        <td>
          <button class="btn btn-edit btn-sm" onclick="window.sasaranStrategiModule?.edit('${item.id}') || SasaranStrategiModule.edit('${item.id}')" title="Edit">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-delete btn-sm" onclick="window.sasaranStrategiModule?.delete('${item.id}') || SasaranStrategiModule.delete('${item.id}')" title="Hapus">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      </tr>
    `).join('');
  }

  function getPerspektifLabel(perspektif) {
    const labels = {
      'ES': 'Eksternal Stakeholder',
      'IBP': 'Internal Business Process',
      'LG': 'Learning & Growth',
      'Fin': 'Financial'
    };
    return labels[perspektif] || perspektif;
  }

  function getPerspektifColor(perspektif) {
    const colors = {
      'ES': 'info',      // Biru untuk Eksternal Stakeholder
      'IBP': 'success',  // Hijau untuk Internal Business Process
      'LG': 'warning',   // Kuning untuk Learning & Growth
      'Fin': 'danger'    // Merah untuk Financial
    };
    return colors[perspektif] || 'secondary';
  }

  function getBadgeStyle(colorType) {
    const styles = {
      'info': 'background-color: #17a2b8; color: white;',
      'success': 'background-color: #28a745; color: white;',
      'warning': 'background-color: #ffc107; color: #212529;',
      'danger': 'background-color: #dc3545; color: white;',
      'secondary': 'background-color: #6c757d; color: white;'
    };
    return styles[colorType] || styles.secondary;
  }

  function getTowsBadgeStyle(tipeStrategi) {
    const styles = {
      'SO': 'background-color: #28a745; color: white;',  // Hijau untuk Strengths-Opportunities
      'WO': 'background-color: #17a2b8; color: white;',  // Biru untuk Weaknesses-Opportunities
      'ST': 'background-color: #ffc107; color: #212529;', // Kuning untuk Strengths-Threats
      'WT': 'background-color: #dc3545; color: white;'   // Merah untuk Weaknesses-Threats
    };
    return styles[tipeStrategi] || 'background-color: #6c757d; color: white;';
  }

  async function applyFilter() {
    const container = document.getElementById('sasaran-strategi-content');
    if (!container) return;
    
    // Try to get filter values from enhanced HTML first
    const rencanaSelect = container.querySelector('#filter-rencana-strategis, #filter-rencana') || document.getElementById('filter-rencana-strategis');
    const towsSelect = container.querySelector('#filter-tows-strategi, #filter-tows') || document.getElementById('filter-tows-strategi');
    const perspektifSelect = container.querySelector('#filter-perspektif') || document.getElementById('filter-perspektif');
    
    state.filters.rencana_strategis_id = rencanaSelect?.value || '';
    state.filters.tows_strategi_id = towsSelect?.value || '';
    state.filters.perspektif = perspektifSelect?.value || '';
    
    await fetchInitialData();
    await render();
  }

  async function showModal(id = null) {
    // Load data first if in edit mode
    let editData = null;
    if (id) {
      try {
        editData = await api()(`/api/sasaran-strategi/${id}`);
      } catch (error) {
        alert('Error loading data: ' + error.message);
        return;
      }
    }

    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
          <h3 class="modal-title">${id ? 'Edit' : 'Tambah'} Sasaran Strategi</h3>
          <button class="modal-close" data-close-modal>&times;</button>
        </div>
        <form id="sasaran-strategi-form">
          <div class="form-group">
            <label class="form-label">Rencana Strategis *</label>
            <select class="form-control" id="ss-rencana-strategis" required>
              <option value="">Pilih Rencana Strategis</option>
              ${state.rencanaStrategis.map(r => `<option value="${r.id}" ${editData && editData.rencana_strategis_id === r.id ? 'selected' : ''}>${r.nama_rencana}</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">TOWS Strategi</label>
            <select class="form-control" id="ss-tows-strategi">
              <option value="">Pilih TOWS Strategi (Opsional)</option>
              ${state.towsStrategi.map(t => `
                <option value="${t.id}" title="${t.strategi}" ${editData && editData.tows_strategi_id === t.id ? 'selected' : ''}>
                  ${t.tipe_strategi}: ${t.strategi.length > 60 ? t.strategi.substring(0, 60) + '...' : t.strategi}
                </option>
              `).join('')}
            </select>
            <small class="form-text text-muted">Pilih strategi TOWS yang relevan dengan sasaran ini (opsional)</small>
          </div>
          <div class="form-group">
            <label class="form-label">Perspektif *</label>
            <select class="form-control" id="ss-perspektif" required>
              <option value="">Pilih Perspektif</option>
              <option value="ES" ${editData && editData.perspektif === 'ES' ? 'selected' : ''}>ES (Eksternal Stakeholder)</option>
              <option value="IBP" ${editData && editData.perspektif === 'IBP' ? 'selected' : ''}>IBP (Internal Business Process)</option>
              <option value="LG" ${editData && editData.perspektif === 'LG' ? 'selected' : ''}>LG (Learning & Growth)</option>
              <option value="Fin" ${editData && editData.perspektif === 'Fin' ? 'selected' : ''}>Fin (Financial)</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Sasaran *</label>
            <textarea class="form-control" id="ss-sasaran" required rows="4">${editData ? editData.sasaran : ''}</textarea>
          </div>
          <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
            <button type="button" class="btn btn-secondary" data-close-modal>Batal</button>
            <button type="submit" class="btn btn-primary">Simpan</button>
          </div>
        </form>
      </div>
    `;
    document.body.appendChild(modal);

    // Attach close event listeners - single click to close
    const closeButtons = modal.querySelectorAll('[data-close-modal]');
    closeButtons.forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        modal.remove();
      });
    });

    // Close modal when clicking outside
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    });

    // Attach form submit handler
    const form = modal.querySelector('#sasaran-strategi-form');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      await save(e, id);
    });
  }



  async function save(e, id) {
    e.preventDefault();
    e.stopPropagation();
    
    try {
      const data = {
        rencana_strategis_id: document.getElementById('ss-rencana-strategis').value,
        tows_strategi_id: document.getElementById('ss-tows-strategi').value || null,
        perspektif: document.getElementById('ss-perspektif').value,
        sasaran: document.getElementById('ss-sasaran').value
      };

      if (id) {
        await api()(`/api/sasaran-strategi/${id}`, { method: 'PUT', body: data });
      } else {
        await api()('/api/sasaran-strategi', { method: 'POST', body: data });
      }

      // Close modal immediately
      const modal = document.querySelector('.modal');
      if (modal) {
        modal.remove();
      }
      
      // Show success message
      alert('Sasaran strategi berhasil disimpan');
      
      // Reload data
      await load();
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }

  async function edit(id) {
    await showModal(id);
  }

  async function deleteItem(id) {
    if (!confirm('Yakin ingin menghapus sasaran strategi ini?')) return;
    try {
      await api()(`/api/sasaran-strategi/${id}`, { method: 'DELETE' });
      await load();
      alert('Sasaran strategi berhasil dihapus');
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }

  async function downloadReport() {
    try {
      // Fetch report data from backend
      const reportData = await api()('/api/sasaran-strategi/report');
      
      if (!reportData || reportData.length === 0) {
        alert('Tidak ada data untuk diunduh');
        return;
      }

      // Prepare data for Excel
      const excelData = reportData.map(item => ({
        'No': item.no,
        'Rencana Strategis': item.rencana_strategis,
        'Sasaran': item.sasaran,
        'Perspektif': getPerspektifLabel(item.perspektif),
        'Tipe TOWS': item.tipe_tows,
        'Strategi TOWS': item.strategi_tows,
        'Tanggal Dibuat': new Date(item.created_at).toLocaleDateString('id-ID'),
        'Terakhir Diupdate': new Date(item.updated_at).toLocaleDateString('id-ID')
      }));

      // Create workbook
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(excelData);

      // Set column widths
      const colWidths = [
        { wch: 5 },   // No
        { wch: 25 },  // Rencana Strategis
        { wch: 40 },  // Sasaran
        { wch: 20 },  // Perspektif
        { wch: 10 },  // Tipe TOWS
        { wch: 50 },  // Strategi TOWS
        { wch: 15 },  // Tanggal Dibuat
        { wch: 15 }   // Terakhir Diupdate
      ];
      ws['!cols'] = colWidths;

      // Add title row
      XLSX.utils.sheet_add_aoa(ws, [['LAPORAN SASARAN STRATEGI']], { origin: 'A1' });
      XLSX.utils.sheet_add_aoa(ws, [['Tanggal Cetak: ' + new Date().toLocaleDateString('id-ID')]], { origin: 'A2' });
      XLSX.utils.sheet_add_aoa(ws, [['']], { origin: 'A3' }); // Empty row

      // Merge title cells
      ws['!merges'] = [
        { s: { r: 0, c: 0 }, e: { r: 0, c: 7 } }, // Title
        { s: { r: 1, c: 0 }, e: { r: 1, c: 7 } }  // Date
      ];

      // Add worksheet to workbook
      XLSX.utils.book_append_sheet(wb, ws, 'Sasaran Strategi');

      // Generate filename with timestamp
      const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
      const filename = `Laporan_Sasaran_Strategi_${timestamp}.xlsx`;

      // Download file
      XLSX.writeFile(wb, filename);

      alert('Laporan berhasil diunduh!');
    } catch (error) {
      console.error('Error downloading report:', error);
      alert('Gagal mengunduh laporan: ' + error.message);
    }
  }

  async function autoCorrelate() {
    if (!confirm('Apakah Anda yakin ingin mengkorelasikan sasaran strategi dengan TOWS strategi secara otomatis menggunakan AI?\n\nProses ini akan menghubungkan sasaran yang belum memiliki korelasi TOWS dengan strategi TOWS yang paling relevan.')) {
      return;
    }

    try {
      // Show loading state
      const button = event.target;
      const originalText = button.innerHTML;
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';
      button.disabled = true;

      const result = await api()('/api/sasaran-strategi/auto-correlate', { method: 'POST' });
      
      // Restore button
      button.innerHTML = originalText;
      button.disabled = false;

      if (result.correlations && result.correlations.length > 0) {
        // Show correlation results
        showCorrelationResults(result.correlations);
        // Reload data to show updated correlations
        await load();
      } else {
        alert(result.message || 'Tidak ada korelasi baru yang dibuat');
      }
    } catch (error) {
      console.error('Auto-correlate error:', error);
      alert('Gagal melakukan auto korelasi: ' + error.message);
      
      // Restore button on error
      const button = event.target;
      button.innerHTML = '<i class="fas fa-magic"></i> Auto Korelasi AI';
      button.disabled = false;
    }
  }

  function showCorrelationResults(correlations) {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
      <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
        <div class="modal-header">
          <h3 class="modal-title">Hasil Auto Korelasi AI</h3>
          <button class="modal-close" data-close-modal>&times;</button>
        </div>
        <div style="padding: 1rem;">
          <p><strong>Berhasil mengkorelasikan ${correlations.length} sasaran strategi:</strong></p>
          <div style="max-height: 400px; overflow-y: auto;">
            ${correlations.map((corr, index) => `
              <div style="border: 1px solid #ddd; border-radius: 4px; padding: 1rem; margin-bottom: 1rem; background: #f9f9f9;">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
                  <strong>${index + 1}. Sasaran (${corr.perspektif}):</strong>
                  <span class="badge" style="
                    padding: 0.2rem 0.4rem;
                    font-size: 0.7rem;
                    border-radius: 0.2rem;
                    ${getTowsBadgeStyle(corr.tows_type)}
                  ">${corr.tows_type}</span>
                </div>
                <p style="margin: 0.5rem 0; color: #333;">${corr.sasaran_text}</p>
                <div style="margin-top: 0.5rem;">
                  <strong>Dikorelasikan dengan TOWS:</strong>
                  <p style="margin: 0.25rem 0; color: #666; font-size: 0.9rem;">${corr.tows_strategy}</p>
                  <small style="color: #28a745;">Confidence: ${corr.confidence}%</small>
                </div>
              </div>
            `).join('')}
          </div>
          <div style="text-align: center; margin-top: 1rem;">
            <button class="btn btn-primary" data-close-modal>Tutup</button>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    
    // Attach close event listeners
    const closeButtons = modal.querySelectorAll('[data-close-modal]');
    closeButtons.forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        modal.remove();
      });
    });
  }

  return {
    load,
    showModal,
    applyFilter,
    save,
    edit,
    delete: deleteItem,
    downloadReport,
    autoCorrelate
  };
})();

async function loadSasaranStrategi() {
  await SasaranStrategiModule.load();
}

window.sasaranStrategiModule = SasaranStrategiModule;

