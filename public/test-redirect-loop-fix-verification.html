<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirect Loop Fix Verification</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
        }
        
        h1, h2 {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .test-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #4CAF50;
        }
        
        .test-button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        .test-button.danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }
        
        .test-button.warning {
            background: linear-gradient(45deg, #ff9800, #f57c00);
        }
        
        .test-results {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status.success { background: #4CAF50; }
        .status.error { background: #f44336; }
        .status.warning { background: #ff9800; }
        .status.info { background: #2196F3; }
        
        .auth-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .navigation-test {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .fix-summary {
            background: rgba(76, 175, 80, 0.2);
            border: 2px solid #4CAF50;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .fix-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        
        .fix-item::before {
            content: 'âœ…';
            margin-right: 10px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ›¡ï¸ Redirect Loop Fix Verification</h1>
        <p style="text-align: center; font-size: 18px; margin-bottom: 30px;">
            Comprehensive testing tool for the redirect loop fix implementation
        </p>
        
        <!-- Authentication State Display -->
        <div class="test-section">
            <h2>ğŸ” Current Authentication State</h2>
            <div class="auth-info" id="auth-info">
                <div>Loading authentication state...</div>
            </div>
            <button class="test-button" onclick="refreshAuthState()">ğŸ”„ Refresh Auth State</button>
            <button class="test-button warning" onclick="clearAuthState()">ğŸ—‘ï¸ Clear Auth State</button>
        </div>
        
        <!-- Navigation Tests -->
        <div class="test-section">
            <h2>ğŸ§­ Navigation Loop Prevention Tests</h2>
            <p>Test navigation between different pages to verify no loops occur:</p>
            
            <div class="navigation-test">
                <button class="test-button" onclick="testNavigation('/dashboard')">ğŸ“Š Go to Dashboard</button>
                <button class="test-button" onclick="testNavigation('/login')">ğŸ” Go to Login</button>
                <button class="test-button" onclick="testNavigation('/')">ğŸ  Go to Home</button>
                <button class="test-button" onclick="testNavigation('/visi-misi')">ğŸ¯ Go to Visi Misi</button>
                <button class="test-button" onclick="testNavigation('/risks')">âš ï¸ Go to Risks</button>
                <button class="test-button" onclick="testNavigation('/pengaturan')">âš™ï¸ Go to Settings</button>
            </div>
            
            <div class="test-results" id="navigation-results">
                <div>Navigation test results will appear here...</div>
            </div>
        </div>
        
        <!-- Authentication Flow Tests -->
        <div class="test-section">
            <h2>ğŸ”„ Authentication Flow Tests</h2>
            <p>Test various authentication scenarios:</p>
            
            <button class="test-button" onclick="testLoginFlow()">ğŸ”‘ Test Login Flow</button>
            <button class="test-button" onclick="testLogoutFlow()">ğŸšª Test Logout Flow</button>
            <button class="test-button" onclick="testPageRefresh()">ğŸ”„ Test Page Refresh</button>
            <button class="test-button" onclick="testSessionExpiry()">â° Test Session Expiry</button>
            <button class="test-button danger" onclick="testRapidNavigation()">âš¡ Test Rapid Navigation</button>
            
            <div class="test-results" id="auth-flow-results">
                <div>Authentication flow test results will appear here...</div>
            </div>
        </div>
        
        <!-- System Status -->
        <div class="test-section">
            <h2>ğŸ“Š System Status</h2>
            <div id="system-status">
                <div>Loading system status...</div>
            </div>
            <button class="test-button" onclick="checkSystemStatus()">ğŸ” Check System Status</button>
        </div>
        
        <!-- Fix Summary -->
        <div class="fix-summary">
            <h2>ğŸ¯ Redirect Loop Fix Summary</h2>
            <div class="fix-item">Enhanced AuthStateManager with caching and persistence</div>
            <div class="fix-item">Improved race condition handling with promise tracking</div>
            <div class="fix-item">Enhanced login loop prevention with better auth state checking</div>
            <div class="fix-item">Better router integration with AuthStateManager</div>
            <div class="fix-item">Improved session validation and caching</div>
            <div class="fix-item">Enhanced error recovery and fallback mechanisms</div>
            <div class="fix-item">Better state synchronization across components</div>
            <div class="fix-item">Reduced authentication check frequency with smart caching</div>
        </div>
    </div>

    <script>
        // Global variables for testing
        let navigationHistory = [];
        let testResults = [];
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ§ª Redirect Loop Fix Verification Tool Loaded');
            refreshAuthState();
            checkSystemStatus();
        });
        
        // Refresh authentication state display
        function refreshAuthState() {
            const authInfo = document.getElementById('auth-info');
            
            try {
                const authState = {
                    isAuthenticated: window.isAuthenticated || false,
                    currentUser: window.currentUser ? {
                        email: window.currentUser.email,
                        id: window.currentUser.id
                    } : null,
                    hasSession: !!(window.currentSession && window.currentSession.access_token),
                    authStateManager: window.authStateManager ? {
                        isAuthenticated: window.authStateManager.isAuthenticated,
                        hasUser: !!window.authStateManager.currentUser,
                        hasSession: !!window.authStateManager.currentSession,
                        authCheckInProgress: window.authStateManager.authCheckInProgress,
                        stats: window.authStateManager.getStats()
                    } : null,
                    loginLoopPrevention: window.loginLoopPrevention ? {
                        stats: window.loginLoopPrevention.getStats()
                    } : null
                };
                
                authInfo.innerHTML = `
                    <div><strong>Global Auth State:</strong> ${authState.isAuthenticated ? 'âœ… Authenticated' : 'âŒ Not Authenticated'}</div>
                    <div><strong>Current User:</strong> ${authState.currentUser ? authState.currentUser.email : 'None'}</div>
                    <div><strong>Has Session:</strong> ${authState.hasSession ? 'âœ… Yes' : 'âŒ No'}</div>
                    ${authState.authStateManager ? `
                        <div><strong>AuthStateManager:</strong> ${authState.authStateManager.isAuthenticated ? 'âœ… Authenticated' : 'âŒ Not Authenticated'}</div>
                        <div><strong>Auth Check In Progress:</strong> ${authState.authStateManager.authCheckInProgress ? 'â³ Yes' : 'âœ… No'}</div>
                        <div><strong>Cache Size:</strong> ${authState.authStateManager.stats.cacheSize || 0}</div>
                        <div><strong>Listeners:</strong> ${authState.authStateManager.stats.listenersCount || 0}</div>
                    ` : '<div><strong>AuthStateManager:</strong> âŒ Not Available</div>'}
                    ${authState.loginLoopPrevention ? `
                        <div><strong>Loop Prevention:</strong> âœ… Active</div>
                        <div><strong>Navigation History:</strong> ${authState.loginLoopPrevention.stats.historySize || 0} entries</div>
                    ` : '<div><strong>Loop Prevention:</strong> âŒ Not Available</div>'}
                `;
                
                console.log('ğŸ” Auth State:', authState);
                
            } catch (error) {
                authInfo.innerHTML = `<div style="color: #f44336;">âŒ Error reading auth state: ${error.message}</div>`;
                console.error('Error refreshing auth state:', error);
            }
        }
        
        // Clear authentication state
        function clearAuthState() {
            try {
                if (window.authStateManager) {
                    window.authStateManager.clearState();
                }
                
                window.isAuthenticated = false;
                window.currentUser = null;
                window.currentSession = null;
                
                localStorage.removeItem('supabase.auth.token');
                sessionStorage.removeItem('authStateManager');
                
                addTestResult('Clear Auth State', 'âœ… Authentication state cleared successfully', 'success');
                refreshAuthState();
                
            } catch (error) {
                addTestResult('Clear Auth State', `âŒ Error: ${error.message}`, 'error');
                console.error('Error clearing auth state:', error);
            }
        }
        
        // Test navigation to different pages
        function testNavigation(path) {
            const startTime = Date.now();
            const currentPath = window.location.pathname;
            
            addTestResult('Navigation Test', `ğŸ§­ Testing navigation from ${currentPath} to ${path}`, 'info');
            
            try {
                // Record navigation attempt
                navigationHistory.push({
                    from: currentPath,
                    to: path,
                    timestamp: Date.now(),
                    authState: window.isAuthenticated
                });
                
                // Test with loop prevention if available
                if (window.loginLoopPrevention) {
                    const success = window.loginLoopPrevention.safeNavigate(path, 'verification-test');
                    const duration = Date.now() - startTime;
                    
                    if (success) {
                        addTestResult('Navigation Test', `âœ… Safe navigation to ${path} completed in ${duration}ms`, 'success');
                    } else {
                        addTestResult('Navigation Test', `âš ï¸ Safe navigation to ${path} was blocked (loop prevention)`, 'warning');
                    }
                } else {
                    // Fallback navigation
                    if (window.appRouter) {
                        window.appRouter.navigate(path);
                        addTestResult('Navigation Test', `âœ… Router navigation to ${path} initiated`, 'success');
                    } else if (typeof navigateToPage === 'function') {
                        const pageName = path.replace(/^\//, '') || 'dashboard';
                        navigateToPage(pageName);
                        addTestResult('Navigation Test', `âœ… Legacy navigation to ${pageName} initiated`, 'success');
                    } else {
                        window.location.href = path;
                        addTestResult('Navigation Test', `âœ… Direct navigation to ${path} initiated`, 'success');
                    }
                }
                
            } catch (error) {
                addTestResult('Navigation Test', `âŒ Navigation error: ${error.message}`, 'error');
                console.error('Navigation test error:', error);
            }
        }
        
        // Test login flow
        function testLoginFlow() {
            addTestResult('Login Flow Test', 'ğŸ”‘ Testing login flow...', 'info');
            
            try {
                // Simulate login process
                if (window.authService && typeof window.authService.login === 'function') {
                    addTestResult('Login Flow Test', 'âœ… AuthService login method available', 'success');
                } else {
                    addTestResult('Login Flow Test', 'âš ï¸ AuthService not available, using fallback', 'warning');
                }
                
                // Test authentication state after login
                setTimeout(() => {
                    refreshAuthState();
                    addTestResult('Login Flow Test', 'âœ… Login flow test completed', 'success');
                }, 1000);
                
            } catch (error) {
                addTestResult('Login Flow Test', `âŒ Login flow error: ${error.message}`, 'error');
            }
        }
        
        // Test logout flow
        function testLogoutFlow() {
            addTestResult('Logout Flow Test', 'ğŸšª Testing logout flow...', 'info');
            
            try {
                if (window.authService && typeof window.authService.logout === 'function') {
                    window.authService.logout().then(() => {
                        addTestResult('Logout Flow Test', 'âœ… Logout completed successfully', 'success');
                        refreshAuthState();
                    }).catch(error => {
                        addTestResult('Logout Flow Test', `âŒ Logout error: ${error.message}`, 'error');
                    });
                } else {
                    // Fallback logout
                    clearAuthState();
                    addTestResult('Logout Flow Test', 'âœ… Fallback logout completed', 'success');
                }
                
            } catch (error) {
                addTestResult('Logout Flow Test', `âŒ Logout flow error: ${error.message}`, 'error');
            }
        }
        
        // Test page refresh behavior
        function testPageRefresh() {
            addTestResult('Page Refresh Test', 'ğŸ”„ Testing page refresh behavior...', 'info');
            
            try {
                // Save current state
                const currentState = {
                    path: window.location.pathname,
                    authState: window.isAuthenticated,
                    timestamp: Date.now()
                };
                
                sessionStorage.setItem('refreshTest', JSON.stringify(currentState));
                
                // Refresh page
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
                
            } catch (error) {
                addTestResult('Page Refresh Test', `âŒ Page refresh test error: ${error.message}`, 'error');
            }
        }
        
        // Test session expiry handling
        function testSessionExpiry() {
            addTestResult('Session Expiry Test', 'â° Testing session expiry handling...', 'info');
            
            try {
                // Simulate expired session
                if (window.currentSession) {
                    const expiredSession = {
                        ...window.currentSession,
                        expires_at: Math.floor(Date.now() / 1000) - 3600 // 1 hour ago
                    };
                    
                    window.currentSession = expiredSession;
                    
                    // Test authentication check with expired session
                    if (window.authStateManager) {
                        const isAuth = window.authStateManager.checkAuthentication();
                        addTestResult('Session Expiry Test', `âœ… Expired session detected: ${!isAuth ? 'Correctly' : 'Incorrectly'} handled`, isAuth ? 'error' : 'success');
                    }
                }
                
                addTestResult('Session Expiry Test', 'âœ… Session expiry test completed', 'success');
                
            } catch (error) {
                addTestResult('Session Expiry Test', `âŒ Session expiry test error: ${error.message}`, 'error');
            }
        }
        
        // Test rapid navigation (stress test)
        function testRapidNavigation() {
            addTestResult('Rapid Navigation Test', 'âš¡ Testing rapid navigation (stress test)...', 'info');
            
            try {
                const paths = ['/dashboard', '/login', '/visi-misi', '/risks', '/dashboard'];
                let completedNavigations = 0;
                
                paths.forEach((path, index) => {
                    setTimeout(() => {
                        try {
                            testNavigation(path);
                            completedNavigations++;
                            
                            if (completedNavigations === paths.length) {
                                addTestResult('Rapid Navigation Test', 'âœ… Rapid navigation stress test completed', 'success');
                            }
                        } catch (error) {
                            addTestResult('Rapid Navigation Test', `âŒ Rapid navigation error: ${error.message}`, 'error');
                        }
                    }, index * 200); // 200ms intervals
                });
                
            } catch (error) {
                addTestResult('Rapid Navigation Test', `âŒ Rapid navigation test error: ${error.message}`, 'error');
            }
        }
        
        // Check system status
        function checkSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            
            try {
                const status = {
                    supabaseClient: !!window.supabaseClient,
                    authService: !!window.authService,
                    authStateManager: !!window.authStateManager,
                    loginLoopPrevention: !!window.loginLoopPrevention,
                    router: !!window.appRouter,
                    routerManager: !!window.RouterManager,
                    configManager: !!window.configManager
                };
                
                statusDiv.innerHTML = Object.entries(status).map(([key, value]) => 
                    `<div><strong>${key}:</strong> ${value ? 'âœ… Available' : 'âŒ Not Available'}</div>`
                ).join('');
                
                console.log('ğŸ“Š System Status:', status);
                
            } catch (error) {
                statusDiv.innerHTML = `<div style="color: #f44336;">âŒ Error checking system status: ${error.message}</div>`;
                console.error('Error checking system status:', error);
            }
        }
        
        // Add test result to display
        function addTestResult(testName, message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const result = `[${timestamp}] ${testName}: ${message}`;
            
            testResults.push({ testName, message, type, timestamp });
            
            // Update navigation results
            const navResults = document.getElementById('navigation-results');
            if (testName.includes('Navigation')) {
                navResults.innerHTML += `<div style="color: ${getColorForType(type)}">${result}</div>`;
                navResults.scrollTop = navResults.scrollHeight;
            }
            
            // Update auth flow results
            const authResults = document.getElementById('auth-flow-results');
            if (!testName.includes('Navigation')) {
                authResults.innerHTML += `<div style="color: ${getColorForType(type)}">${result}</div>`;
                authResults.scrollTop = authResults.scrollHeight;
            }
            
            console.log(`ğŸ§ª ${result}`);
        }
        
        // Get color for result type
        function getColorForType(type) {
            switch (type) {
                case 'success': return '#4CAF50';
                case 'error': return '#f44336';
                case 'warning': return '#ff9800';
                case 'info': return '#2196F3';
                default: return '#ffffff';
            }
        }
        
        // Check for page refresh test result
        window.addEventListener('load', function() {
            try {
                const refreshTest = sessionStorage.getItem('refreshTest');
                if (refreshTest) {
                    const testData = JSON.parse(refreshTest);
                    const timeDiff = Date.now() - testData.timestamp;
                    
                    if (timeDiff < 10000) { // Within 10 seconds
                        addTestResult('Page Refresh Test', `âœ… Page refresh completed. Auth state preserved: ${window.isAuthenticated === testData.authState ? 'Yes' : 'No'}`, 
                            window.isAuthenticated === testData.authState ? 'success' : 'warning');
                        sessionStorage.removeItem('refreshTest');
                    }
                }
            } catch (error) {
                console.warn('Error checking refresh test result:', error);
            }
        });
    </script>
</body>
</html>