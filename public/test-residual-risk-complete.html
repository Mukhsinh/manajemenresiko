<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Residual Risk Complete</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f6fa;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-body {
            padding: 20px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn:hover { opacity: 0.9; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            padding: 20px;
            border-radius: 12px;
            color: white;
            text-align: center;
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .chart-wrapper {
            position: relative;
            height: 400px;
        }
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
        }
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .badge-low { background: #d4edda; color: #155724; }
        .badge-medium { background: #fff3cd; color: #856404; }
        .badge-high { background: #f8d7da; color: #721c24; }
        .badge-extreme { background: #f5c6cb; color: #721c24; }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .download-section {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h1><i class="fas fa-chart-pie"></i> Residual Risk Analysis - Complete Test</h1>
                <div>
                    <button class="btn btn-success" onclick="loadData()">
                        <i class="fas fa-sync"></i> Refresh Data
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="status"></div>
                
                <!-- Statistics -->
                <div id="statistics" class="stats-grid" style="display: none;"></div>
                
                <!-- Charts -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div class="chart-container">
                        <h3><i class="fas fa-chart-scatter"></i> Residual Risk Matrix</h3>
                        <div class="chart-wrapper">
                            <canvas id="residualMatrix"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3><i class="fas fa-chart-bar"></i> Inherent vs Residual Comparison</h3>
                        <div class="chart-wrapper">
                            <canvas id="comparisonChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Download Section -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-download"></i> Download Reports</h3>
                    </div>
                    <div class="card-body">
                        <div class="download-section">
                            <button class="btn btn-success" onclick="downloadExcel()">
                                <i class="fas fa-file-excel"></i> Download Excel
                            </button>
                            <button class="btn btn-warning" onclick="downloadPDF()">
                                <i class="fas fa-file-pdf"></i> Download PDF
                            </button>
                            <button class="btn btn-primary" onclick="printReport()">
                                <i class="fas fa-print"></i> Print Report
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Data Table -->
                <div class="table-container">
                    <h3><i class="fas fa-table"></i> Residual Risk Data</h3>
                    <div id="dataTable"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let residualData = [];
        let matrixChart = null;
        let comparisonChart = null;

        // API call function
        async function apiCall(endpoint, options = {}) {
            const token = localStorage.getItem('authToken');
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` })
                }
            };
            
            const response = await fetch(endpoint, { ...defaultOptions, ...options });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return response.json();
        }

        // Load residual risk data
        async function loadData() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading residual risk data...</div>';
            
            try {
                // Test login first if no token
                if (!localStorage.getItem('authToken')) {
                    await testLogin();
                }
                
                // Load residual risk data
                residualData = await apiCall('/api/reports/residual-risk');
                
                statusDiv.innerHTML = `<div class="success">
                    <i class="fas fa-check-circle"></i> 
                    Successfully loaded ${residualData.length} residual risk records
                </div>`;
                
                renderStatistics();
                renderCharts();
                renderTable();
                
            } catch (error) {
                console.error('Error loading data:', error);
                statusDiv.innerHTML = `<div class="error">
                    <i class="fas fa-exclamation-triangle"></i> 
                    Error loading data: ${error.message}
                </div>`;
            }
        }

        // Test login
        async function testLogin() {
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@example.com',
                        password: 'admin123'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('authToken', data.token);
                } else {
                    throw new Error('Login failed');
                }
            } catch (error) {
                throw new Error('Authentication failed: ' + error.message);
            }
        }

        // Render statistics
        function renderStatistics() {
            if (residualData.length === 0) return;
            
            const stats = calculateStatistics();
            const statsDiv = document.getElementById('statistics');
            
            statsDiv.innerHTML = `
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="stat-value">${stats.total}</div>
                    <div class="stat-label">Total Residual Risks</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="stat-value">${stats.avgInherent.toFixed(2)}</div>
                    <div class="stat-label">Avg Inherent Value</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <div class="stat-value">${stats.avgResidual.toFixed(2)}</div>
                    <div class="stat-label">Avg Residual Value</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <div class="stat-value">${stats.reduction}%</div>
                    <div class="stat-label">Risk Reduction</div>
                </div>
            `;
            
            statsDiv.style.display = 'grid';
        }

        // Calculate statistics
        function calculateStatistics() {
            const total = residualData.length;
            const avgInherent = residualData.reduce((sum, item) => {
                const inherent = item.risk_inputs?.risk_inherent_analysis?.[0];
                return sum + (inherent?.risk_value || 0);
            }, 0) / (total || 1);
            
            const avgResidual = residualData.reduce((sum, item) => {
                return sum + (item.risk_value || 0);
            }, 0) / (total || 1);
            
            const reduction = avgInherent > 0 ? ((avgInherent - avgResidual) / avgInherent * 100).toFixed(1) : 0;
            
            return { total, avgInherent, avgResidual, reduction };
        }

        // Render charts
        function renderCharts() {
            renderResidualMatrix();
            renderComparisonChart();
        }

        // Render residual risk matrix
        function renderResidualMatrix() {
            const ctx = document.getElementById('residualMatrix');
            if (!ctx) return;
            
            if (matrixChart) {
                matrixChart.destroy();
            }
            
            const points = residualData.map(item => ({
                x: item.impact || 0,
                y: item.probability || 0,
                riskCode: item.risk_inputs?.kode_risiko || 'N/A',
                value: item.risk_value || 0,
                level: item.risk_level || 'LOW RISK'
            })).filter(p => p.x > 0 && p.y > 0);
            
            matrixChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Residual Risk',
                        data: points,
                        backgroundColor: points.map(p => getRiskColor(p.level)),
                        borderColor: '#333',
                        borderWidth: 2,
                        pointRadius: 10,
                        pointHoverRadius: 12
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            min: 0.5,
                            max: 5.5,
                            ticks: { stepSize: 1 },
                            title: { display: true, text: 'Impact' }
                        },
                        y: {
                            min: 0.5,
                            max: 5.5,
                            ticks: { stepSize: 1 },
                            title: { display: true, text: 'Probability' }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = context.raw;
                                    return [
                                        `Code: ${point.riskCode}`,
                                        `Value: ${point.value}`,
                                        `Level: ${point.level}`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }

        // Render comparison chart
        function renderComparisonChart() {
            const ctx = document.getElementById('comparisonChart');
            if (!ctx) return;
            
            if (comparisonChart) {
                comparisonChart.destroy();
            }
            
            const labels = residualData.slice(0, 10).map(item => 
                item.risk_inputs?.kode_risiko || 'N/A'
            );
            
            const inherentValues = residualData.slice(0, 10).map(item => {
                const inherent = item.risk_inputs?.risk_inherent_analysis?.[0];
                return inherent?.risk_value || 0;
            });
            
            const residualValues = residualData.slice(0, 10).map(item => 
                item.risk_value || 0
            );
            
            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Inherent Risk',
                            data: inherentValues,
                            backgroundColor: 'rgba(231, 76, 60, 0.7)',
                            borderColor: 'rgba(231, 76, 60, 1)',
                            borderWidth: 2
                        },
                        {
                            label: 'Residual Risk',
                            data: residualValues,
                            backgroundColor: 'rgba(52, 152, 219, 0.7)',
                            borderColor: 'rgba(52, 152, 219, 1)',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Risk Value' }
                        }
                    },
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });
        }

        // Render data table
        function renderTable() {
            const tableDiv = document.getElementById('dataTable');
            
            if (residualData.length === 0) {
                tableDiv.innerHTML = '<p>No residual risk data available.</p>';
                return;
            }
            
            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Risk Code</th>
                            <th>Unit Kerja</th>
                            <th>Inherent</th>
                            <th>Residual</th>
                            <th>Reduction</th>
                            <th>Level</th>
                            <th>Review Status</th>
                            <th>Next Review</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${residualData.map(item => {
                            const risk = item.risk_inputs || {};
                            const inherent = risk.risk_inherent_analysis?.[0] || {};
                            const reduction = inherent.risk_value && item.risk_value 
                                ? ((inherent.risk_value - item.risk_value) / inherent.risk_value * 100).toFixed(1) + '%'
                                : '-';
                            
                            return `
                                <tr>
                                    <td><strong>${risk.kode_risiko || '-'}</strong></td>
                                    <td>${risk.master_work_units?.name || '-'}</td>
                                    <td><span class="badge ${getBadgeClass(inherent.risk_level)}">${inherent.risk_value || '-'}</span></td>
                                    <td><span class="badge ${getBadgeClass(item.risk_level)}">${item.risk_value || '-'}</span></td>
                                    <td><strong style="color: #27ae60;">${reduction}</strong></td>
                                    <td><span class="badge ${getBadgeClass(item.risk_level)}">${item.risk_level || '-'}</span></td>
                                    <td>${item.review_status || '-'}</td>
                                    <td>${item.next_review_date || '-'}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            tableDiv.innerHTML = tableHTML;
        }

        // Get risk color
        function getRiskColor(level) {
            const colors = {
                'EXTREME HIGH': '#F44336',
                'HIGH RISK': '#FF9800',
                'MEDIUM RISK': '#FFC107',
                'LOW RISK': '#4CAF50'
            };
            return colors[level] || '#999';
        }

        // Get badge class
        function getBadgeClass(level) {
            const classes = {
                'EXTREME HIGH': 'badge-extreme',
                'HIGH RISK': 'badge-high',
                'MEDIUM RISK': 'badge-medium',
                'LOW RISK': 'badge-low'
            };
            return classes[level] || 'badge-low';
        }

        // Download functions
        async function downloadExcel() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/reports/residual-risk/excel', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `residual-risk-${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } else {
                    throw new Error('Download failed');
                }
            } catch (error) {
                alert('Error downloading Excel: ' + error.message);
            }
        }

        async function downloadPDF() {
            alert('PDF download feature will be implemented soon');
        }

        function printReport() {
            window.print();
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>