<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test UI Freeze Fix - Rencana Strategis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-log { font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .test-log .success { color: #28a745; }
        .test-log .error { color: #dc3545; }
        .test-log .info { color: #17a2b8; }
        .test-log .warn { color: #ffc107; }
        .metric-card { background: #f8f9fa; border-radius: 8px; padding: 15px; margin: 5px 0; }
        .metric-value { font-size: 24px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <h2><i class="fas fa-bug me-2"></i>Test UI Freeze Fix</h2>
        <p class="text-muted">Verifikasi perbaikan UI freeze pada halaman Rencana Strategis</p>
        
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="text-muted small">Load Time</div>
                    <div class="metric-value" id="load-time">-</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="text-muted small">Long Tasks</div>
                    <div class="metric-value" id="long-tasks">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="text-muted small">Render Chunks</div>
                    <div class="metric-value" id="render-chunks">-</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="text-muted small">Status</div>
                    <div class="metric-value" id="status">‚è≥</div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header">Test Controls</div>
                    <div class="card-body">
                        <button class="btn btn-primary me-2" onclick="runTest()">
                            <i class="fas fa-play me-1"></i>Run Test
                        </button>
                        <button class="btn btn-warning me-2" onclick="testMultipleCalls()">
                            <i class="fas fa-clone me-1"></i>Test Multiple Calls
                        </button>
                        <button class="btn btn-secondary" onclick="clearLog()">
                            <i class="fas fa-trash me-1"></i>Clear Log
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">Test Log</div>
                    <div class="card-body test-log" id="test-log"></div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Rencana Strategis Content</div>
                    <div class="card-body" style="min-height: 400px;">
                        <div id="rencana-strategis-content">
                            <p class="text-muted text-center py-5">Click "Run Test" to load module</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/config.js"></script>
    <script src="/js/services/apiService.js"></script>
    <script src="/js/rencana-strategis-optimized-v2.js"></script>
    
    <script>
        let longTaskCount = 0;
        let renderChunks = 0;
        
        // Monitor long tasks
        if ('PerformanceObserver' in window) {
            const observer = new PerformanceObserver((list) => {
                for (const entry of list.getEntries()) {
                    if (entry.duration > 50) {
                        longTaskCount++;
                        document.getElementById('long-tasks').textContent = longTaskCount;
                        log(`‚ö†Ô∏è Long task detected: ${entry.duration.toFixed(2)}ms`, 'warn');
                    }
                }
            });
            try {
                observer.observe({ entryTypes: ['longtask'] });
            } catch (e) {
                log('Long task observer not supported', 'info');
            }
        }
        
        // Intercept console.log to track render chunks
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            const msg = args.join(' ');
            if (msg.includes('Chunk') || msg.includes('chunk')) {
                renderChunks++;
                document.getElementById('render-chunks').textContent = renderChunks;
            }
        };
        
        function log(message, type = 'info') {
            const logEl = document.getElementById('test-log');
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `<div class="${type}">[${time}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('test-log').innerHTML = '';
            longTaskCount = 0;
            renderChunks = 0;
            document.getElementById('long-tasks').textContent = '0';
            document.getElementById('render-chunks').textContent = '-';
            document.getElementById('load-time').textContent = '-';
            document.getElementById('status').textContent = '‚è≥';
        }
        
        async function runTest() {
            clearLog();
            log('üöÄ Starting UI freeze test...', 'info');
            
            const startTime = performance.now();
            
            try {
                // Simulate being on rencana-strategis page
                history.pushState({}, '', '/rencana-strategis');
                
                log('üìç Simulated navigation to /rencana-strategis', 'info');
                log('‚è≥ Loading module...', 'info');
                
                await window.RencanaStrategisModule.load();
                
                const endTime = performance.now();
                const loadTime = (endTime - startTime).toFixed(2);
                
                document.getElementById('load-time').textContent = `${loadTime}ms`;
                document.getElementById('status').textContent = '‚úÖ';
                
                log(`‚úÖ Module loaded in ${loadTime}ms`, 'success');
                log(`üìä Long tasks: ${longTaskCount}`, longTaskCount > 0 ? 'warn' : 'success');
                log(`üé® Render chunks: ${renderChunks}`, 'info');
                
                // Check if content rendered
                const container = document.getElementById('rencana-strategis-content');
                const hasTable = container.querySelector('table');
                const hasCards = container.querySelector('.rencana-strategis-wrapper');
                
                if (hasTable && hasCards) {
                    log('‚úÖ Interface rendered correctly (cards + table)', 'success');
                } else {
                    log('‚ùå Interface not rendered correctly', 'error');
                }
                
            } catch (error) {
                document.getElementById('status').textContent = '‚ùå';
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        async function testMultipleCalls() {
            log('üîÑ Testing multiple concurrent calls...', 'info');
            
            // Simulate multiple calls (race condition test)
            const promises = [
                window.RencanaStrategisModule.load(),
                window.RencanaStrategisModule.load(),
                window.RencanaStrategisModule.load()
            ];
            
            const results = await Promise.allSettled(promises);
            
            log(`üìä ${results.length} calls made`, 'info');
            log('‚úÖ Mutex should prevent multiple executions', 'success');
            log('Check console for "Module already executing" messages', 'info');
        }
        
        // Initial log
        log('Test page loaded. Click "Run Test" to start.', 'info');
        log(`Module version: ${window.RencanaStrategisModule?.version || 'Not loaded'}`, 'info');
    </script>
</body>
</html>
