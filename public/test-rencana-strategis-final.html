<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rencana Strategis - Final Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .test-header { background: #ffffff; color: white; padding: 2rem 0; }
        .status-card { border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
    </style>
</head>
<body>
    <div class="test-header">
        <div class="container">
            <h1><i class="fas fa-chart-line"></i> Rencana Strategis - Final Test</h1>
            <p class="mb-0">Testing the enhanced module with proper table display</p>
        </div>
    </div>
    
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-4">
                <div class="card status-card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-cogs"></i> Module Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="module-status">Checking...</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card status-card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-eye"></i> Display Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="display-status">Loading...</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card status-card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-database"></i> Data Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="data-status">Waiting...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Test Area -->
        <div class="card status-card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-table"></i> Rencana Strategis Display Test</h5>
            </div>
            <div class="card-body p-0">
                <div id="rencana-strategis" class="page-content active">
                    <div id="rencana-strategis-content" class="p-4"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Mock dependencies
        window.apiCall = async (url) => {
            console.log('Mock API call:', url);
            await new Promise(resolve => setTimeout(resolve, 500)); // Simulate network delay
            
            if (url.includes('rencana-strategis')) {
                return [
                    {
                        id: '1',
                        kode: 'RS-2025-001',
                        nama_rencana: 'Peningkatan Kualitas Pelayanan Medis',
                        status: 'Aktif',
                        target: 'Meningkatkan kepuasan pasien hingga 95%',
                        periode_mulai: '2025-01-01',
                        periode_selesai: '2025-12-31',
                        deskripsi: 'Program komprehensif untuk meningkatkan kualitas pelayanan medis di seluruh unit kerja rumah sakit'
                    },
                    {
                        id: '2',
                        kode: 'RS-2025-002',
                        nama_rencana: 'Digitalisasi Sistem Informasi',
                        status: 'Draft',
                        target: 'Implementasi SIMRS terintegrasi 100%',
                        periode_mulai: '2025-03-01',
                        periode_selesai: '2025-12-31',
                        deskripsi: 'Transformasi digital sistem informasi rumah sakit untuk efisiensi operasional'
                    },
                    {
                        id: '3',
                        kode: 'RS-2025-003',
                        nama_rencana: 'Program Keselamatan Pasien',
                        status: 'Selesai',
                        target: 'Zero incident keselamatan pasien',
                        periode_mulai: '2024-01-01',
                        periode_selesai: '2024-12-31',
                        deskripsi: 'Program komprehensif keselamatan pasien dengan standar internasional'
                    }
                ];
            }
            
            if (url.includes('visi-misi')) {
                return [
                    {
                        id: '1',
                        misi: 'Memberikan pelayanan kesehatan terbaik\nMeningkatkan kualitas SDM\nMengembangkan teknologi medis'
                    }
                ];
            }
            
            return [];
        };
        
        window.app = { apiCall: window.apiCall };
        window.waitForAuthReady = async () => true;
        window.isAuthenticated = true;
        window.currentUser = { id: '1', email: 'test@example.com' };
        
        // Status checking functions
        function checkModuleStatus() {
            const statusDiv = document.getElementById('module-status');
            let status = [];
            
            if (typeof window.RencanaStrategisModuleEnhanced !== 'undefined') {
                status.push('<span class="success">‚úÖ Enhanced Module Found</span>');
                
                if (typeof window.RencanaStrategisModuleEnhanced.load === 'function') {
                    status.push('<span class="success">‚úÖ Load Function Available</span>');
                } else {
                    status.push('<span class="error">‚ùå Load Function Missing</span>');
                }
            } else {
                status.push('<span class="error">‚ùå Enhanced Module Not Found</span>');
            }
            
            // Check for old modules
            if (typeof window.RencanaStrategisModule !== 'undefined') {
                status.push('<span class="warning">‚ö†Ô∏è Old Module Still Present</span>');
            } else {
                status.push('<span class="success">‚úÖ No Old Module Conflicts</span>');
            }
            
            statusDiv.innerHTML = status.join('<br>');
        }
        
        function checkDisplayStatus() {
            const statusDiv = document.getElementById('display-status');
            const content = document.getElementById('rencana-strategis-content');
            
            if (!content) {
                statusDiv.innerHTML = '<span class="error">‚ùå Content Container Missing</span>';
                return;
            }
            
            const contentHTML = content.innerHTML;
            let status = [];
            
            // Check for old display elements
            if (contentHTML.includes('Pilih Rencana Strategis')) {
                status.push('<span class="error">‚ùå Old Display Detected</span>');
            } else {
                status.push('<span class="success">‚úÖ No Old Display</span>');
            }
            
            // Check for new display elements
            if (contentHTML.includes('Daftar Rencana Strategis') || contentHTML.includes('Total Rencana')) {
                status.push('<span class="success">‚úÖ Enhanced Display Active</span>');
            } else {
                status.push('<span class="warning">‚ö†Ô∏è Enhanced Display Not Found</span>');
            }
            
            // Check for table structure
            if (contentHTML.includes('<table') && contentHTML.includes('table-responsive')) {
                status.push('<span class="success">‚úÖ Table Structure Present</span>');
            } else {
                status.push('<span class="warning">‚ö†Ô∏è Table Structure Missing</span>');
            }
            
            statusDiv.innerHTML = status.join('<br>');
        }
        
        function checkDataStatus() {
            const statusDiv = document.getElementById('data-status');
            
            if (window.RencanaStrategisModuleEnhanced && window.RencanaStrategisModuleEnhanced.state) {
                const state = window.RencanaStrategisModuleEnhanced.state;
                let status = [];
                
                status.push(`<span class="success">‚úÖ Data Count: ${state.data ? state.data.length : 0}</span>`);
                status.push(`<span class="success">‚úÖ Missions: ${state.missions ? state.missions.length : 0}</span>`);
                
                if (state.isInitialized) {
                    status.push('<span class="success">‚úÖ Module Initialized</span>');
                } else {
                    status.push('<span class="warning">‚ö†Ô∏è Module Not Initialized</span>');
                }
                
                statusDiv.innerHTML = status.join('<br>');
            } else {
                statusDiv.innerHTML = '<span class="warning">‚ö†Ô∏è Module State Not Available</span>';
            }
        }
        
        // Main test execution
        async function runTest() {
            console.log('üß™ Starting Rencana Strategis Final Test...');
            
            try {
                // Check initial status
                checkModuleStatus();
                
                // Load the enhanced module
                if (window.RencanaStrategisModuleEnhanced && window.RencanaStrategisModuleEnhanced.load) {
                    console.log('üöÄ Loading enhanced module...');
                    await window.RencanaStrategisModuleEnhanced.load();
                    
                    // Check status after loading
                    setTimeout(() => {
                        checkDisplayStatus();
                        checkDataStatus();
                    }, 1000);
                    
                    console.log('‚úÖ Test completed successfully');
                } else {
                    console.error('‚ùå Enhanced module not available');
                    document.getElementById('display-status').innerHTML = '<span class="error">‚ùå Module Not Available</span>';
                }
                
            } catch (error) {
                console.error('‚ùå Test failed:', error);
                document.getElementById('display-status').innerHTML = '<span class="error">‚ùå Test Failed: ' + error.message + '</span>';
            }
        }
        
        // Load scripts and run test
        document.addEventListener('DOMContentLoaded', () => {
            // Load conflict prevention first
            const conflictScript = document.createElement('script');
            conflictScript.src = '/js/rencana-strategis-conflict-prevention.js';
            conflictScript.onload = () => {
                // Then load the main module
                const mainScript = document.createElement('script');
                mainScript.src = '/js/rencana-strategis.js';
                mainScript.onload = () => {
                    console.log('üì¶ All scripts loaded');
                    runTest();
                };
                mainScript.onerror = () => {
                    document.getElementById('module-status').innerHTML = '<span class="error">‚ùå Failed to load main script</span>';
                };
                document.head.appendChild(mainScript);
            };
            conflictScript.onerror = () => {
                console.warn('‚ö†Ô∏è Conflict prevention script not found, continuing...');
                // Load main script anyway
                const mainScript = document.createElement('script');
                mainScript.src = '/js/rencana-strategis.js';
                mainScript.onload = () => runTest();
                document.head.appendChild(mainScript);
            };
            document.head.appendChild(conflictScript);
        });
    </script>
</body>
</html>