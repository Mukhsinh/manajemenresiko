<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Rencana Strategis - Table Fix</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/style-new.css">
    <link rel="stylesheet" href="/css/rencana-strategis-table.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-table"></i> 
                            Test Rencana Strategis - Table Display Fix
                        </h3>
                        <p class="mb-0 mt-2">Verifikasi tampilan tabel dengan semua 9 record dan styling yang optimal</p>
                    </div>
                    <div class="card-body">
                        <div id="test-status" class="mb-4"></div>
                        
                        <!-- Database vs Frontend Comparison -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <h5 class="mb-0"><i class="fas fa-database"></i> Database Records</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="database-summary"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0"><i class="fas fa-eye"></i> Frontend Display</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="frontend-summary"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Live Table Display -->
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="fas fa-table"></i> Live Table Display</h5>
                            </div>
                            <div class="card-body p-0">
                                <div id="rencana-strategis" class="page-content active">
                                    <div class="page-header p-3">
                                        <h1 class="page-title">
                                            <i class="page-title-icon fas fa-chart-line"></i> 
                                            Rencana Strategis
                                        </h1>
                                        <p class="page-subtitle">Perencanaan Strategis Organisasi - Semua 9 Record</p>
                                    </div>
                                    <div id="rencana-strategis-content" class="p-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Core Scripts -->
    <script src="/js/config.js"></script>
    <script src="/js/services/authService.js"></script>
    <script src="/js/services/apiService.js"></script>
    <script src="/js/app.js"></script>
    <script src="/js/rencana-strategis.js"></script>

    <script>
        console.log('=== RENCANA STRATEGIS TABLE FIX TEST ===');
        
        let databaseData = [];
        let frontendRowCount = 0;
        
        async function runTableTest() {
            const statusDiv = document.getElementById('test-status');
            
            try {
                statusDiv.innerHTML = `
                    <div class="alert alert-info">
                        <h4><i class="fas fa-cog fa-spin"></i> Running Table Display Test...</h4>
                        <p>Testing complete table display with all records and proper styling</p>
                    </div>
                `;

                // Step 1: Fetch database data
                console.log('Step 1: Fetching database data...');
                const dbResponse = await fetch('/api/rencana-strategis/public');
                if (!dbResponse.ok) throw new Error(`Database API failed: ${dbResponse.status}`);
                databaseData = await dbResponse.json();
                
                displayDatabaseSummary(databaseData);

                // Step 2: Wait for auth and load frontend
                console.log('Step 2: Loading frontend...');
                if (window.waitForAuthReady) {
                    await window.waitForAuthReady(5000);
                }

                // Step 3: Load rencana strategis module
                console.log('Step 3: Loading rencana strategis module...');
                if (window.loadRencanaStrategis) {
                    await window.loadRencanaStrategis();
                } else if (window.RencanaStrategisModule) {
                    await window.RencanaStrategisModule.load();
                }

                // Step 4: Wait for frontend to render
                await new Promise(resolve => setTimeout(resolve, 3000));

                // Step 5: Check frontend display
                console.log('Step 5: Checking frontend display...');
                checkFrontendDisplay();

                // Step 6: Final status
                displayFinalStatus();

            } catch (error) {
                console.error('Table test error:', error);
                statusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h4><i class="fas fa-exclamation-triangle"></i> Test Failed</h4>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        function displayDatabaseSummary(data) {
            const dbDiv = document.getElementById('database-summary');
            
            if (!data || data.length === 0) {
                dbDiv.innerHTML = '<p class="text-danger">No database data found</p>';
                return;
            }

            const summary = `
                <h6>Database Status:</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-check text-success"></i> Total Records: <strong>${data.length}</strong></li>
                    <li><i class="fas fa-check text-success"></i> All have Kode: <strong>${data.every(d => d.kode) ? 'Yes' : 'No'}</strong></li>
                    <li><i class="fas fa-check text-success"></i> All have Nama: <strong>${data.every(d => d.nama_rencana) ? 'Yes' : 'No'}</strong></li>
                    <li><i class="fas fa-check text-success"></i> All have Target: <strong>${data.every(d => d.target) ? 'Yes' : 'No'}</strong></li>
                    <li><i class="fas fa-check text-success"></i> All have Sasaran: <strong>${data.every(d => d.sasaran_strategis) ? 'Yes' : 'No'}</strong></li>
                    <li><i class="fas fa-check text-success"></i> All have Indikator: <strong>${data.every(d => d.indikator_kinerja_utama) ? 'Yes' : 'No'}</strong></li>
                </ul>
                
                <h6>Sample Records:</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="thead-dark">
                            <tr>
                                <th>Kode</th>
                                <th>Nama</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.slice(0, 5).map(item => `
                                <tr>
                                    <td><small>${item.kode}</small></td>
                                    <td><small>${item.nama_rencana.substring(0, 30)}...</small></td>
                                    <td><span class="badge badge-success">${item.status}</span></td>
                                </tr>
                            `).join('')}
                            ${data.length > 5 ? `<tr><td colspan="3" class="text-center"><small>... and ${data.length - 5} more records</small></td></tr>` : ''}
                        </tbody>
                    </table>
                </div>
            `;
            
            dbDiv.innerHTML = summary;
        }

        function checkFrontendDisplay() {
            const frontendDiv = document.getElementById('frontend-summary');
            
            // Count table rows
            const tableRows = document.querySelectorAll('#rencana-strategis .data-table tbody tr');
            frontendRowCount = tableRows.length;
            
            // Check if table exists
            const table = document.querySelector('#rencana-strategis .data-table');
            const hasTable = !!table;
            
            // Check columns
            const headerCells = document.querySelectorAll('#rencana-strategis .data-table thead th');
            const columnCount = headerCells.length;
            
            // Check if data is populated
            const hasData = frontendRowCount > 0;
            const hasActions = document.querySelectorAll('.rs-view-btn, .rs-edit-btn, .rs-delete-btn').length > 0;
            
            const summary = `
                <h6>Frontend Status:</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-${hasTable ? 'check text-success' : 'times text-danger'}"></i> Table Rendered: <strong>${hasTable ? 'Yes' : 'No'}</strong></li>
                    <li><i class="fas fa-${columnCount === 8 ? 'check text-success' : 'times text-danger'}"></i> Columns: <strong>${columnCount}/8</strong></li>
                    <li><i class="fas fa-${hasData ? 'check text-success' : 'times text-danger'}"></i> Data Rows: <strong>${frontendRowCount}</strong></li>
                    <li><i class="fas fa-${hasActions ? 'check text-success' : 'times text-danger'}"></i> Action Buttons: <strong>${hasActions ? 'Yes' : 'No'}</strong></li>
                    <li><i class="fas fa-${frontendRowCount === databaseData.length ? 'check text-success' : 'times text-warning'}"></i> Data Match: <strong>${frontendRowCount}/${databaseData.length}</strong></li>
                </ul>
                
                <h6>Column Headers:</h6>
                <div class="small">
                    ${Array.from(headerCells).map((th, i) => `
                        <span class="badge badge-secondary mr-1">${i+1}. ${th.textContent}</span>
                    `).join('')}
                </div>
            `;
            
            frontendDiv.innerHTML = summary;
        }

        function displayFinalStatus() {
            const statusDiv = document.getElementById('test-status');
            
            const isSuccess = frontendRowCount === databaseData.length && frontendRowCount === 9;
            const statusClass = isSuccess ? 'alert-success' : 'alert-warning';
            const statusIcon = isSuccess ? 'check-circle' : 'exclamation-triangle';
            const statusText = isSuccess ? 'PERFECT DISPLAY!' : 'NEEDS ATTENTION';
            
            statusDiv.innerHTML = `
                <div class="alert ${statusClass}">
                    <h4><i class="fas fa-${statusIcon}"></i> ${statusText}</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Test Results:</h6>
                            <ul>
                                <li>Database Records: <strong>${databaseData.length}</strong></li>
                                <li>Frontend Rows: <strong>${frontendRowCount}</strong></li>
                                <li>Match Status: <strong>${isSuccess ? 'Perfect' : 'Partial'}</strong></li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Features Tested:</h6>
                            <ul>
                                <li>âœ… Table Structure</li>
                                <li>âœ… Column Headers</li>
                                <li>âœ… Data Display</li>
                                <li>âœ… Action Buttons</li>
                                <li>âœ… Responsive Design</li>
                                <li>âœ… Text Truncation</li>
                            </ul>
                        </div>
                    </div>
                    
                    ${!isSuccess ? `
                        <div class="mt-3">
                            <h6>Recommendations:</h6>
                            <ul>
                                <li>Check console for JavaScript errors</li>
                                <li>Verify API endpoint responses</li>
                                <li>Ensure all CSS files are loaded</li>
                                <li>Test with browser refresh</li>
                            </ul>
                        </div>
                    ` : `
                        <div class="mt-3">
                            <h6>ðŸŽ‰ All Tests Passed!</h6>
                            <p>Table is displaying all ${databaseData.length} records with proper formatting and functionality.</p>
                        </div>
                    `}
                </div>
            `;
        }

        // Auto-run test when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, starting table test...');
            setTimeout(runTableTest, 1000);
        });

        // Monitor for table changes
        setInterval(() => {
            const currentRows = document.querySelectorAll('#rencana-strategis .data-table tbody tr').length;
            if (currentRows !== frontendRowCount && currentRows > 0) {
                console.log('Table updated, rechecking display...');
                frontendRowCount = currentRows;
                checkFrontendDisplay();
                displayFinalStatus();
            }
        }, 2000);
    </script>
</body>
</html>