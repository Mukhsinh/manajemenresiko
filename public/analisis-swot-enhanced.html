<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisis SWOT - Enhanced</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* Hide kuantitas column */
        .kuantitas-column {
            display: none !important;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        .swot-table {
            min-width: 1200px;
            font-size: 0.9em;
        }
        
        .swot-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
            border: 1px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .swot-table td {
            vertical-align: middle;
            border: 1px solid #dee2e6;
            padding: 8px 12px;
        }
        
        /* Category badges - fixed positioning */
        .badge-strength { 
            background-color: #10b981; 
            color: white;
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .badge-weakness { 
            background-color: #ef4444; 
            color: white;
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .badge-opportunity { 
            background-color: #3b82f6; 
            color: white;
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .badge-threat { 
            background-color: #f59e0b; 
            color: #1e293b;
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        /* Table category column - ensure badges stay within column */
        .kategori-column {
            min-width: 120px;
            max-width: 120px;
            text-align: center;
            vertical-align: middle;
        }
        
        /* Rencana Strategis column styling */
        .rencana-strategis-column {
            max-width: 200px;
            word-wrap: break-word;
            font-size: 0.85em;
        }
        
        .rencana-strategis-column .kode {
            font-weight: 600;
            color: #495057;
            display: block;
            margin-bottom: 2px;
        }
        
        .rencana-strategis-column .nama {
            color: #6c757d;
            font-size: 0.9em;
            line-height: 1.2;
        }
        
        /* Other column styling */
        .objek-analisis-column {
            max-width: 300px;
            word-wrap: break-word;
            line-height: 1.3;
        }
        
        .bobot-column {
            text-align: center;
            font-weight: 600;
            color: #495057;
            min-width: 60px;
        }
        
        .score-column {
            text-align: center;
            font-weight: 700;
            color: #495057;
            min-width: 60px;
        }
        
        .rank-column {
            text-align: center;
            min-width: 60px;
        }
        
        .unit-kerja-column {
            max-width: 150px;
            word-wrap: break-word;
            font-weight: 500;
        }
        
        .tahun-column {
            text-align: center;
            min-width: 60px;
            font-weight: 500;
        }
        
        /* Filter section - consistent with other pages */
        .filter-section {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 1px solid #cbd5e1;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .filter-section .form-label {
            font-weight: 600;
            color: #334155;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .filter-section .form-select {
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            background-color: white;
            transition: all 0.2s ease;
        }
        
        .filter-section .form-select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }
        
        /* Summary cards - enhanced with Lucide icons */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            text-align: center;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--card-color);
        }
        
        .summary-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
        }
        
        .summary-card.strength {
            --card-color: #10b981;
        }
        
        .summary-card.weakness {
            --card-color: #ef4444;
        }
        
        .summary-card.opportunity {
            --card-color: #3b82f6;
        }
        
        .summary-card.threat {
            --card-color: #f59e0b;
        }
        
        .card-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem;
            background: var(--card-color);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }
        
        .card-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--card-color);
            margin-bottom: 0.5rem;
            line-height: 1;
        }
        
        .card-subtitle {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 1rem;
        }
        
        .card-stats {
            display: flex;
            justify-content: space-between;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }
        
        .card-stat {
            text-align: center;
        }
        
        .card-stat-label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }
        
        .card-stat-value {
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        /* Loading and no data states */
        .loading, .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .loading i, .no-data i {
            font-size: 1.5em;
            margin-right: 10px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .swot-table {
                font-size: 0.8em;
            }
            
            .rencana-strategis-column {
                max-width: 150px;
            }
            
            .objek-analisis-column {
                max-width: 200px;
            }
            
            .summary-cards {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2><i data-lucide="bar-chart-3"></i> Analisis SWOT Enhanced</h2>
                        <p class="text-muted mb-0">Analisis SWOT dengan korelasi rencana strategis dan total score per kategori</p>
                    </div>
                    <button class="btn btn-primary" onclick="refreshData()">
                        <i data-lucide="refresh-cw"></i> Refresh
                    </button>
                </div>

                <!-- Filter Section -->
                <div class="filter-section">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">Unit Kerja</label>
                            <select id="filterUnitKerja" class="form-select" onchange="applyFilters()">
                                <option value="">Semua Unit Kerja</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Kategori</label>
                            <select id="filterKategori" class="form-select" onchange="applyFilters()">
                                <option value="">Semua Kategori</option>
                                <option value="Strength">Strength</option>
                                <option value="Weakness">Weakness</option>
                                <option value="Opportunity">Opportunity</option>
                                <option value="Threat">Threat</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Rencana Strategis</label>
                            <select id="filterRencanaStrategis" class="form-select" onchange="applyFilters()">
                                <option value="">Semua Rencana Strategis</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Tahun</label>
                            <select id="filterTahun" class="form-select" onchange="applyFilters()">
                                <option value="">Semua Tahun</option>
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="summary-cards" id="summaryCards">
                    <!-- Summary cards will be populated here -->
                </div>

                <!-- Data Table -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Data Analisis SWOT</h5>
                        <small class="text-muted">Setiap perspektif memiliki 5 data dengan total bobot 100 (kelipatan 5). Kolom kuantitas disembunyikan.</small>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table table-striped swot-table" id="swotTable">
                                <thead>
                                    <tr>
                                        <th class="unit-kerja-column">Unit Kerja</th>
                                        <th class="kategori-column">Kategori (Perspektif)</th>
                                        <th class="rencana-strategis-column">Rencana Strategis</th>
                                        <th class="objek-analisis-column">Objek Analisis</th>
                                        <th class="bobot-column">Bobot</th>
                                        <th class="rank-column">Rank</th>
                                        <th class="score-column">Score</th>
                                        <th class="tahun-column">Tahun</th>
                                        <!-- Kuantitas column is hidden with CSS -->
                                        <th class="kuantitas-column">Kuantitas</th>
                                    </tr>
                                </thead>
                                <tbody id="swotTableBody">
                                    <tr>
                                        <td colspan="8" class="loading">
                                            <i class="fas fa-spinner fa-spin"></i> Memuat data...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allData = [];
        let filteredData = [];
        let unitKerjaList = [];
        let rencanaStrategisList = [];

        // API Configuration
        const API_BASE_URL = window.location.origin;
        
        async function apiCall(endpoint, options = {}) {
            const token = localStorage.getItem('token');
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token ? `Bearer ${token}` : ''
                }
            };
            
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                ...defaultOptions,
                ...options,
                headers: { ...defaultOptions.headers, ...options.headers }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return await response.json();
        }

        async function loadInitialData() {
            try {
                console.log('Loading SWOT data...');
                
                // Load SWOT data with related data
                const swotData = await apiCall('/api/analisis-swot');
                console.log('SWOT data loaded:', swotData.length, 'items');
                
                // Load unit kerja
                const unitKerjaData = await apiCall('/api/master-data/work-units');
                unitKerjaList = unitKerjaData || [];
                
                // Load rencana strategis
                const rencanaStrategisData = await apiCall('/api/rencana-strategis');
                rencanaStrategisList = rencanaStrategisData || [];
                
                // Process and enhance data
                allData = swotData.map(item => ({
                    ...item,
                    unit_kerja_name: getUnitKerjaName(item.unit_kerja_id),
                    rencana_strategis_info: getRencanaStrategisInfo(item.rencana_strategis_id || item.rencana_strategis?.id)
                }));
                
                filteredData = [...allData];
                
                populateFilters();
                renderSummaryCards();
                renderTable();
                
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Gagal memuat data: ' + error.message);
            }
        }

        function getUnitKerjaName(unitKerjaId) {
            if (!unitKerjaId) return 'Unknown Unit';
            const unit = unitKerjaList.find(u => u.id === unitKerjaId);
            return unit ? unit.name : 'Unknown Unit';
        }

        function getRencanaStrategisInfo(rencanaStrategisId) {
            if (!rencanaStrategisId) {
                return { kode: '-', nama: 'Tidak terkait' };
            }
            
            const rencana = rencanaStrategisList.find(r => r.id === rencanaStrategisId);
            return rencana ? {
                kode: rencana.kode,
                nama: rencana.nama_rencana
            } : {
                kode: '-',
                nama: 'Tidak ditemukan'
            };
        }

        function populateFilters() {
            // Populate Unit Kerja filter
            const unitKerjaSelect = document.getElementById('filterUnitKerja');
            unitKerjaSelect.innerHTML = '<option value="">Semua Unit Kerja</option>';
            
            const uniqueUnits = [...new Set(allData.map(item => item.unit_kerja_id).filter(Boolean))];
            uniqueUnits.forEach(unitId => {
                const unitName = getUnitKerjaName(unitId);
                unitKerjaSelect.innerHTML += `<option value="${unitId}">${unitName}</option>`;
            });

            // Populate Rencana Strategis filter
            const rencanaSelect = document.getElementById('filterRencanaStrategis');
            rencanaSelect.innerHTML = '<option value="">Semua Rencana Strategis</option>';
            
            rencanaStrategisList.forEach(rencana => {
                rencanaSelect.innerHTML += `<option value="${rencana.id}">${rencana.kode} - ${rencana.nama_rencana}</option>`;
            });
        }

        function applyFilters() {
            const unitKerjaFilter = document.getElementById('filterUnitKerja').value;
            const kategoriFilter = document.getElementById('filterKategori').value;
            const rencanaFilter = document.getElementById('filterRencanaStrategis').value;
            const tahunFilter = document.getElementById('filterTahun').value;

            filteredData = allData.filter(item => {
                return (!unitKerjaFilter || item.unit_kerja_id === unitKerjaFilter) &&
                       (!kategoriFilter || item.kategori === kategoriFilter) &&
                       (!rencanaFilter || item.rencana_strategis_id === rencanaFilter) &&
                       (!tahunFilter || item.tahun.toString() === tahunFilter);
            });

            renderSummaryCards();
            renderTable();
        }

        function renderSummaryCards() {
            const summaryContainer = document.getElementById('summaryCards');
            
            // Calculate summary by category
            const summary = {
                Strength: { count: 0, totalScore: 0, totalBobot: 0 },
                Weakness: { count: 0, totalScore: 0, totalBobot: 0 },
                Opportunity: { count: 0, totalScore: 0, totalBobot: 0 },
                Threat: { count: 0, totalScore: 0, totalBobot: 0 }
            };

            filteredData.forEach(item => {
                if (summary[item.kategori]) {
                    summary[item.kategori].count++;
                    summary[item.kategori].totalScore += item.score || 0;
                    summary[item.kategori].totalBobot += item.bobot || 0;
                }
            });

            const cardConfig = {
                Strength: { 
                    icon: 'trending-up', 
                    class: 'strength',
                    title: 'Kekuatan'
                },
                Weakness: { 
                    icon: 'trending-down', 
                    class: 'weakness',
                    title: 'Kelemahan'
                },
                Opportunity: { 
                    icon: 'lightbulb', 
                    class: 'opportunity',
                    title: 'Peluang'
                },
                Threat: { 
                    icon: 'alert-triangle', 
                    class: 'threat',
                    title: 'Ancaman'
                }
            };

            summaryContainer.innerHTML = Object.keys(summary).map(category => {
                const config = cardConfig[category];
                const data = summary[category];
                
                return `
                    <div class="summary-card ${config.class}">
                        <div class="card-icon">
                            <i data-lucide="${config.icon}"></i>
                        </div>
                        <div class="card-title">${config.title}</div>
                        <div class="card-value">${data.totalScore}</div>
                        <div class="card-subtitle">Total Score</div>
                        <div class="card-stats">
                            <div class="card-stat">
                                <div class="card-stat-label">Items</div>
                                <div class="card-stat-value">${data.count}</div>
                            </div>
                            <div class="card-stat">
                                <div class="card-stat-label">Bobot</div>
                                <div class="card-stat-value">${data.totalBobot}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function renderTable() {
            const tbody = document.getElementById('swotTableBody');
            
            if (filteredData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="no-data">
                            <i class="fas fa-info-circle"></i> Tidak ada data yang sesuai dengan filter
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredData.map(item => `
                <tr>
                    <td class="unit-kerja-column">${item.unit_kerja_name}</td>
                    <td class="kategori-column">
                        <span class="badge badge-${item.kategori.toLowerCase()}">${item.kategori}</span>
                    </td>
                    <td class="rencana-strategis-column">
                        <span class="kode">${item.rencana_strategis_info.kode}</span>
                        <span class="nama">${item.rencana_strategis_info.nama}</span>
                    </td>
                    <td class="objek-analisis-column">${item.objek_analisis}</td>
                    <td class="bobot-column">${item.bobot}</td>
                    <td class="rank-column">${item.rank}</td>
                    <td class="score-column">${item.score}</td>
                    <td class="tahun-column">${item.tahun}</td>
                    <!-- Kuantitas column is hidden with CSS -->
                    <td class="kuantitas-column">${item.kuantitas || 1}</td>
                </tr>
            `).join('');
        }

        function showError(message) {
            const tbody = document.getElementById('swotTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle"></i> ${message}
                    </td>
                </tr>
            `;
        }

        async function refreshData() {
            const tbody = document.getElementById('swotTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Memuat ulang data...
                    </td>
                </tr>
            `;
            
            await loadInitialData();
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing SWOT Analisis Enhanced...');
            
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            loadInitialData();
        });
    </script>
</body>
</html>