<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Laporan UUID Fix</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-section {
            margin: 2rem 0;
            padding: 1.5rem;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .log-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.875rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status-success { color: #28a745; }
        .status-error { color: #dc3545; }
        .status-warning { color: #ffc107; }
        .status-info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1><i class="fas fa-bug"></i> Test Laporan UUID Fix</h1>
                <p class="lead">Testing untuk memverifikasi perbaikan error UUID pada download laporan</p>
                
                <!-- Login Section -->
                <div class="test-section">
                    <h3><i class="fas fa-sign-in-alt"></i> Login Test</h3>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="loginEmail" value="admin@example.com">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-control" id="loginPassword" value="admin123">
                            </div>
                            <button class="btn btn-primary" onclick="testLogin()">
                                <i class="fas fa-sign-in-alt"></i> Test Login
                            </button>
                            <button class="btn btn-secondary ms-2" onclick="testWithoutAuth()">
                                <i class="fas fa-play"></i> Test Without Auth
                            </button>
                        </div>
                        <div class="col-md-6">
                            <div class="log-output" id="loginLog">Login test results will appear here...</div>
                        </div>
                    </div>
                </div>

                <!-- Debug Endpoints Test -->
                <div class="test-section">
                    <h3><i class="fas fa-cog"></i> Debug Endpoints Test</h3>
                    <div class="row">
                        <div class="col-md-6">
                            <button class="btn btn-info me-2 mb-2" onclick="testDebugEndpoint('/api/reports/test-excel-download')">
                                <i class="fas fa-file-excel"></i> Test Excel Download
                            </button>
                            <button class="btn btn-info me-2 mb-2" onclick="testDebugEndpoint('/api/reports/risk-register-excel-debug')">
                                <i class="fas fa-file-excel"></i> Risk Register Debug
                            </button>
                            <button class="btn btn-info me-2 mb-2" onclick="testDebugEndpoint('/api/reports/risk-register-debug')">
                                <i class="fas fa-database"></i> Risk Register Data
                            </button>
                            <button class="btn btn-info me-2 mb-2" onclick="testDebugEndpoint('/api/reports/residual-risk-simple')">
                                <i class="fas fa-chart-pie"></i> Residual Risk Simple
                            </button>
                            <button class="btn btn-info me-2 mb-2" onclick="testDebugEndpoint('/api/reports/residual-risk-pdf-debug')">
                                <i class="fas fa-file-pdf"></i> PDF Debug
                            </button>
                        </div>
                        <div class="col-md-6">
                            <div class="log-output" id="debugLog">Debug test results will appear here...</div>
                        </div>
                    </div>
                </div>

                <!-- Auth Required Endpoints Test -->
                <div class="test-section">
                    <h3><i class="fas fa-lock"></i> Auth Required Endpoints Test</h3>
                    <div class="row">
                        <div class="col-md-6">
                            <button class="btn btn-warning me-2 mb-2" onclick="testAuthEndpoint('/api/reports/user-debug')">
                                <i class="fas fa-user"></i> User Debug
                            </button>
                            <button class="btn btn-success me-2 mb-2" onclick="testAuthEndpoint('/api/reports/risk-register/excel')">
                                <i class="fas fa-file-excel"></i> Risk Register Excel
                            </button>
                            <button class="btn btn-success me-2 mb-2" onclick="testAuthEndpoint('/api/reports/risk-profile/excel')">
                                <i class="fas fa-file-excel"></i> Risk Profile Excel
                            </button>
                            <button class="btn btn-success me-2 mb-2" onclick="testAuthEndpoint('/api/reports/residual-risk/excel')">
                                <i class="fas fa-file-excel"></i> Residual Risk Excel
                            </button>
                            <button class="btn btn-success me-2 mb-2" onclick="testAuthEndpoint('/api/reports/monitoring/excel')">
                                <i class="fas fa-file-excel"></i> Monitoring Excel
                            </button>
                            <button class="btn btn-success me-2 mb-2" onclick="testAuthEndpoint('/api/reports/strategic-map/excel')">
                                <i class="fas fa-file-excel"></i> Strategic Map Excel
                            </button>
                            <button class="btn btn-danger me-2 mb-2" onclick="testAuthEndpoint('/api/reports/residual-risk/pdf')">
                                <i class="fas fa-file-pdf"></i> Residual Risk PDF
                            </button>
                        </div>
                        <div class="col-md-6">
                            <div class="log-output" id="authLog">Auth test results will appear here...</div>
                        </div>
                    </div>
                </div>

                <!-- Test All Button -->
                <div class="test-section">
                    <h3><i class="fas fa-play-circle"></i> Run All Tests</h3>
                    <button class="btn btn-primary btn-lg" onclick="runAllTests()">
                        <i class="fas fa-play"></i> Run All Tests
                    </button>
                    <div class="mt-3">
                        <div class="log-output" id="allTestsLog">All tests results will appear here...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let authToken = null;

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = `status-${type}`;
            element.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            element.scrollTop = element.scrollHeight;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function testLogin() {
            clearLog('loginLog');
            log('loginLog', 'Starting login test...', 'info');

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    log('loginLog', 'âœ“ Login successful!', 'success');
                    log('loginLog', `Token obtained: ${authToken.substring(0, 20)}...`, 'success');
                } else {
                    const errorText = await response.text();
                    log('loginLog', `âœ— Login failed: ${response.status}`, 'error');
                    log('loginLog', `Error: ${errorText}`, 'error');
                }
            } catch (error) {
                log('loginLog', `âœ— Login error: ${error.message}`, 'error');
            }
        }

        async function testDebugEndpoint(endpoint) {
            log('debugLog', `Testing ${endpoint}...`, 'info');

            try {
                const response = await fetch(endpoint);
                
                if (response.ok) {
                    const contentType = response.headers.get('content-type') || '';
                    const contentLength = response.headers.get('content-length') || 0;
                    
                    log('debugLog', `âœ“ ${endpoint} - Success`, 'success');
                    log('debugLog', `  Content-Type: ${contentType}`, 'info');
                    log('debugLog', `  Size: ${contentLength} bytes`, 'info');

                    if (contentType.includes('json')) {
                        try {
                            const data = await response.json();
                            log('debugLog', `  Data preview: ${JSON.stringify(data).substring(0, 100)}...`, 'info');
                        } catch (e) {
                            log('debugLog', '  Could not parse JSON response', 'warning');
                        }
                    }
                } else {
                    const errorText = await response.text();
                    log('debugLog', `âœ— ${endpoint} - Failed: ${response.status}`, 'error');
                    
                    if (errorText.includes('invalid input syntax for type uuid')) {
                        log('debugLog', 'ðŸ” UUID ERROR DETECTED!', 'error');
                        log('debugLog', `Error: ${errorText.substring(0, 200)}`, 'error');
                    } else {
                        log('debugLog', `Error: ${errorText.substring(0, 100)}`, 'error');
                    }
                }
            } catch (error) {
                log('debugLog', `âœ— ${endpoint} - Error: ${error.message}`, 'error');
            }
        }

        async function testAuthEndpoint(endpoint) {
            if (!authToken) {
                log('authLog', 'âš ï¸ No auth token available. Please login first.', 'warning');
                return;
            }

            log('authLog', `Testing ${endpoint}...`, 'info');

            try {
                const response = await fetch(endpoint, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const contentType = response.headers.get('content-type') || '';
                    const contentLength = response.headers.get('content-length') || 0;
                    
                    log('authLog', `âœ“ ${endpoint} - Success`, 'success');
                    log('authLog', `  Content-Type: ${contentType}`, 'info');
                    log('authLog', `  Size: ${contentLength} bytes`, 'info');

                    if (contentType.includes('json')) {
                        try {
                            const data = await response.json();
                            log('authLog', `  Data preview: ${JSON.stringify(data).substring(0, 100)}...`, 'info');
                        } catch (e) {
                            log('authLog', '  Could not parse JSON response', 'warning');
                        }
                    }

                    // If it's an Excel or PDF file, trigger download
                    if (contentType.includes('spreadsheet') || contentType.includes('pdf')) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `test-${endpoint.split('/').pop()}-${Date.now()}.${contentType.includes('pdf') ? 'pdf' : 'xlsx'}`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                        log('authLog', `  File downloaded successfully`, 'success');
                    }
                } else {
                    const errorText = await response.text();
                    log('authLog', `âœ— ${endpoint} - Failed: ${response.status}`, 'error');
                    
                    if (errorText.includes('invalid input syntax for type uuid')) {
                        log('authLog', 'ðŸ” UUID ERROR DETECTED!', 'error');
                        log('authLog', `Error: ${errorText.substring(0, 200)}`, 'error');
                    } else {
                        log('authLog', `Error: ${errorText.substring(0, 100)}`, 'error');
                    }
                }
            } catch (error) {
                log('authLog', `âœ— ${endpoint} - Error: ${error.message}`, 'error');
            }
        }

        async function testWithoutAuth() {
            clearLog('debugLog');
            log('debugLog', 'Testing endpoints without authentication...', 'info');

            const debugEndpoints = [
                '/api/reports/test-excel-download',
                '/api/reports/risk-register-excel-debug',
                '/api/reports/risk-register-debug',
                '/api/reports/residual-risk-simple',
                '/api/reports/residual-risk-pdf-debug'
            ];

            for (const endpoint of debugEndpoints) {
                await testDebugEndpoint(endpoint);
                await new Promise(resolve => setTimeout(resolve, 500)); // Small delay
            }
        }

        async function runAllTests() {
            clearLog('allTestsLog');
            log('allTestsLog', 'Starting comprehensive test suite...', 'info');

            // Test 1: Login
            log('allTestsLog', '=== Phase 1: Login Test ===', 'info');
            await testLogin();
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Test 2: Debug endpoints
            log('allTestsLog', '=== Phase 2: Debug Endpoints ===', 'info');
            await testWithoutAuth();
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Test 3: Auth endpoints (if token available)
            if (authToken) {
                log('allTestsLog', '=== Phase 3: Auth Required Endpoints ===', 'info');
                
                const authEndpoints = [
                    '/api/reports/user-debug',
                    '/api/reports/risk-register/excel',
                    '/api/reports/risk-profile/excel',
                    '/api/reports/residual-risk/excel',
                    '/api/reports/monitoring/excel',
                    '/api/reports/strategic-map/excel'
                ];

                for (const endpoint of authEndpoints) {
                    await testAuthEndpoint(endpoint);
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            } else {
                log('allTestsLog', 'âš ï¸ Skipping auth tests - no token available', 'warning');
            }

            log('allTestsLog', '=== Test Suite Complete ===', 'success');
        }

        // Auto-clear logs on page load
        window.addEventListener('load', () => {
            clearLog('loginLog');
            clearLog('debugLog');
            clearLog('authLog');
            clearLog('allTestsLog');
        });
    </script>
</body>
</html>