<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SWOT Analisis - Enhanced Final</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        .swot-table {
            min-width: 1200px;
        }
        
        .swot-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
            border: 1px solid #dee2e6;
        }
        
        .swot-table td {
            vertical-align: middle;
            border: 1px solid #dee2e6;
        }
        
        .badge-strength { background-color: #28a745; }
        .badge-weakness { background-color: #dc3545; }
        .badge-opportunity { background-color: #17a2b8; }
        .badge-threat { background-color: #ffc107; color: #212529; }
        
        .rencana-strategis-cell {
            max-width: 200px;
            word-wrap: break-word;
            font-size: 0.9em;
        }
        
        .objek-analisis-cell {
            max-width: 300px;
            word-wrap: break-word;
        }
        
        .bobot-cell {
            text-align: center;
            font-weight: 600;
        }
        
        .score-cell {
            text-align: center;
            font-weight: 700;
            color: #495057;
        }
        
        .filter-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .summary-card h5 {
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .summary-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-chart-line"></i> SWOT Analisis - Enhanced</h2>
                    <button class="btn btn-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>

                <!-- Filter Section -->
                <div class="filter-section">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">Unit Kerja</label>
                            <select id="filterUnitKerja" class="form-select" onchange="applyFilters()">
                                <option value="">Semua Unit Kerja</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Kategori</label>
                            <select id="filterKategori" class="form-select" onchange="applyFilters()">
                                <option value="">Semua Kategori</option>
                                <option value="Strength">Strength</option>
                                <option value="Weakness">Weakness</option>
                                <option value="Opportunity">Opportunity</option>
                                <option value="Threat">Threat</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Rencana Strategis</label>
                            <select id="filterRencanaStrategis" class="form-select" onchange="applyFilters()">
                                <option value="">Semua Rencana Strategis</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Tahun</label>
                            <select id="filterTahun" class="form-select" onchange="applyFilters()">
                                <option value="">Semua Tahun</option>
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="summary-cards" id="summaryCards">
                    <!-- Summary cards will be populated here -->
                </div>

                <!-- Data Table -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Data SWOT Analisis</h5>
                        <small class="text-muted">Kolom kuantitas disembunyikan, kolom rencana strategis ditampilkan</small>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table table-striped swot-table" id="swotTable">
                                <thead>
                                    <tr>
                                        <th style="width: 150px;">Unit Kerja</th>
                                        <th style="width: 100px;">Kategori</th>
                                        <th style="width: 200px;">Rencana Strategis</th>
                                        <th style="width: 300px;">Objek Analisis</th>
                                        <th style="width: 80px;">Bobot</th>
                                        <th style="width: 80px;">Rank</th>
                                        <th style="width: 80px;">Score</th>
                                        <th style="width: 80px;">Tahun</th>
                                    </tr>
                                </thead>
                                <tbody id="swotTableBody">
                                    <tr>
                                        <td colspan="8" class="loading">
                                            <i class="fas fa-spinner fa-spin"></i> Memuat data...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allData = [];
        let filteredData = [];
        let unitKerjaList = [];
        let rencanaStrategisList = [];

        // API Configuration
        const API_BASE_URL = window.location.origin;
        
        async function apiCall(endpoint, options = {}) {
            const token = localStorage.getItem('token');
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token ? `Bearer ${token}` : ''
                }
            };
            
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                ...defaultOptions,
                ...options,
                headers: { ...defaultOptions.headers, ...options.headers }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return await response.json();
        }

        async function loadInitialData() {
            try {
                console.log('Loading SWOT data...');
                
                // Load SWOT data with related data
                const swotData = await apiCall('/api/analisis-swot');
                console.log('SWOT data loaded:', swotData.length, 'items');
                
                // Load unit kerja
                const unitKerjaData = await apiCall('/api/master-data/work-units');
                unitKerjaList = unitKerjaData || [];
                
                // Load rencana strategis
                const rencanaStrategisData = await apiCall('/api/rencana-strategis');
                rencanaStrategisList = rencanaStrategisData || [];
                
                // Process and enhance data
                allData = swotData.map(item => ({
                    ...item,
                    unit_kerja_name: getUnitKerjaName(item.unit_kerja_id),
                    rencana_strategis_info: getRencanaStrategisInfo(item.rencana_strategis_id)
                }));
                
                filteredData = [...allData];
                
                populateFilters();
                renderSummaryCards();
                renderTable();
                
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Gagal memuat data: ' + error.message);
            }
        }

        function getUnitKerjaName(unitKerjaId) {
            const unit = unitKerjaList.find(u => u.id === unitKerjaId);
            return unit ? unit.name : 'Unknown Unit';
        }

        function getRencanaStrategisInfo(rencanaStrategisId) {
            const rencana = rencanaStrategisList.find(r => r.id === rencanaStrategisId);
            return rencana ? {
                kode: rencana.kode,
                nama: rencana.nama_rencana
            } : {
                kode: '-',
                nama: 'Tidak terkait'
            };
        }

        function populateFilters() {
            // Populate Unit Kerja filter
            const unitKerjaSelect = document.getElementById('filterUnitKerja');
            unitKerjaSelect.innerHTML = '<option value="">Semua Unit Kerja</option>';
            
            const uniqueUnits = [...new Set(allData.map(item => item.unit_kerja_id))];
            uniqueUnits.forEach(unitId => {
                const unitName = getUnitKerjaName(unitId);
                unitKerjaSelect.innerHTML += `<option value="${unitId}">${unitName}</option>`;
            });

            // Populate Rencana Strategis filter
            const rencanaSelect = document.getElementById('filterRencanaStrategis');
            rencanaSelect.innerHTML = '<option value="">Semua Rencana Strategis</option>';
            
            rencanaStrategisList.forEach(rencana => {
                rencanaSelect.innerHTML += `<option value="${rencana.id}">${rencana.kode} - ${rencana.nama_rencana}</option>`;
            });
        }

        function applyFilters() {
            const unitKerjaFilter = document.getElementById('filterUnitKerja').value;
            const kategoriFilter = document.getElementById('filterKategori').value;
            const rencanaFilter = document.getElementById('filterRencanaStrategis').value;
            const tahunFilter = document.getElementById('filterTahun').value;

            filteredData = allData.filter(item => {
                return (!unitKerjaFilter || item.unit_kerja_id === unitKerjaFilter) &&
                       (!kategoriFilter || item.kategori === kategoriFilter) &&
                       (!rencanaFilter || item.rencana_strategis_id === rencanaFilter) &&
                       (!tahunFilter || item.tahun.toString() === tahunFilter);
            });

            renderSummaryCards();
            renderTable();
        }

        function renderSummaryCards() {
            const summaryContainer = document.getElementById('summaryCards');
            
            // Calculate summary by category
            const summary = {
                Strength: { count: 0, totalScore: 0, totalBobot: 0 },
                Weakness: { count: 0, totalScore: 0, totalBobot: 0 },
                Opportunity: { count: 0, totalScore: 0, totalBobot: 0 },
                Threat: { count: 0, totalScore: 0, totalBobot: 0 }
            };

            filteredData.forEach(item => {
                if (summary[item.kategori]) {
                    summary[item.kategori].count++;
                    summary[item.kategori].totalScore += item.score || 0;
                    summary[item.kategori].totalBobot += item.bobot || 0;
                }
            });

            const cardColors = {
                Strength: 'success',
                Weakness: 'danger',
                Opportunity: 'info',
                Threat: 'warning'
            };

            summaryContainer.innerHTML = Object.keys(summary).map(category => `
                <div class="summary-card border-${cardColors[category]}">
                    <h5 class="text-${cardColors[category]}">${category}</h5>
                    <div class="summary-value text-${cardColors[category]}">${summary[category].count}</div>
                    <div class="small text-muted">
                        Total Score: ${summary[category].totalScore}<br>
                        Total Bobot: ${summary[category].totalBobot}
                    </div>
                </div>
            `).join('');
        }

        function renderTable() {
            const tbody = document.getElementById('swotTableBody');
            
            if (filteredData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="no-data">
                            <i class="fas fa-info-circle"></i> Tidak ada data yang sesuai dengan filter
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredData.map(item => `
                <tr>
                    <td>${item.unit_kerja_name}</td>
                    <td>
                        <span class="badge badge-${item.kategori.toLowerCase()}">${item.kategori}</span>
                    </td>
                    <td class="rencana-strategis-cell">
                        <strong>${item.rencana_strategis_info.kode}</strong><br>
                        <small class="text-muted">${item.rencana_strategis_info.nama}</small>
                    </td>
                    <td class="objek-analisis-cell">${item.objek_analisis}</td>
                    <td class="bobot-cell">${item.bobot}</td>
                    <td class="text-center">${item.rank}</td>
                    <td class="score-cell">${item.score}</td>
                    <td class="text-center">${item.tahun}</td>
                </tr>
            `).join('');
        }

        function showError(message) {
            const tbody = document.getElementById('swotTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle"></i> ${message}
                    </td>
                </tr>
            `;
        }

        async function refreshData() {
            const tbody = document.getElementById('swotTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Memuat ulang data...
                    </td>
                </tr>
            `;
            
            await loadInitialData();
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing SWOT Analisis Enhanced...');
            loadInitialData();
        });
    </script>
</body>
</html>