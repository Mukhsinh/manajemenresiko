<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct Table Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .debug-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.375rem;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="debug-panel">
            <h5>üß™ Direct Table View Test</h5>
            <div id="debug-info">
                <p><strong>Status:</strong> <span id="status">Initializing...</span></p>
                <p><strong>Current View:</strong> <span id="current-view">-</span></p>
                <p><strong>Table Section:</strong> <span id="table-status">-</span></p>
                <p><strong>Selection Section:</strong> <span id="selection-status">-</span></p>
                <p><strong>Data Count:</strong> <span id="data-count">-</span></p>
            </div>
        </div>
        
        <div id="rencana-strategis" class="page-content active">
            <div id="rencana-strategis-content">
                <!-- Content will be rendered here -->
            </div>
        </div>
    </div>

    <script>
        // Mock API dengan data yang lebih lengkap
        window.apiCall = async (endpoint, options = {}) => {
            console.log('üì° API Call:', endpoint, options);
            
            if (endpoint.includes('/api/rencana-strategis')) {
                if (endpoint.includes('/generate/kode')) {
                    return { kode: `RS-2025-${String(Math.floor(Math.random() * 1000)).padStart(3, '0')}` };
                }
                
                // Return mock data
                return [
                    {
                        id: '1',
                        kode: 'RS-2025-001',
                        nama_rencana: 'Peningkatan Kualitas Pelayanan',
                        deskripsi: 'Meningkatkan kualitas pelayanan kesehatan',
                        periode_mulai: '2025-01-01',
                        periode_selesai: '2025-12-31',
                        target: 'Kepuasan pasien 90%',
                        indikator_kinerja: 'IKP',
                        status: 'Aktif'
                    },
                    {
                        id: '2',
                        kode: 'RS-2025-002',
                        nama_rencana: 'Digitalisasi Sistem',
                        deskripsi: 'Implementasi sistem digital',
                        periode_mulai: '2025-02-01',
                        periode_selesai: '2025-11-30',
                        target: 'SIMRS 100%',
                        indikator_kinerja: 'Implementasi',
                        status: 'Draft'
                    }
                ];
            }
            
            if (endpoint.includes('/api/visi-misi')) {
                return [
                    {
                        id: '1',
                        visi: 'Menjadi rumah sakit terdepan',
                        misi: '1. Pelayanan berkualitas\n2. Teknologi terkini'
                    }
                ];
            }
            
            return [];
        };

        window.app = { apiCall: window.apiCall };
        window.waitForAuthReady = async () => {
            console.log('‚úÖ Auth ready');
            return true;
        };

        // Debug functions
        function updateDebugInfo() {
            const tableSection = document.getElementById('table-section');
            const selectionSection = document.getElementById('selection-section');
            const formSection = document.getElementById('form-section');
            
            // Update status
            document.getElementById('table-status').textContent = tableSection ? 
                (tableSection.style.display === 'none' ? 'Hidden' : 'Visible') : 'Not Found';
            
            document.getElementById('selection-status').textContent = selectionSection ? 
                (selectionSection.style.display === 'none' ? 'Hidden' : 'Visible') : 'Not Found';
            
            // Determine current view
            let currentView = 'None';
            if (tableSection && tableSection.style.display !== 'none') {
                currentView = 'Table View';
            } else if (selectionSection && selectionSection.style.display !== 'none') {
                currentView = 'Selection View';
            } else if (formSection && formSection.style.display !== 'none') {
                currentView = 'Form View';
            }
            
            document.getElementById('current-view').textContent = currentView;
            
            // Update data count
            if (window.RencanaStrategisModule && window.RencanaStrategisModule.state) {
                document.getElementById('data-count').textContent = window.RencanaStrategisModule.state.data.length;
            }
            
            return currentView;
        }

        // Force clear any cached modules
        if (window.RencanaStrategisModule) {
            delete window.RencanaStrategisModule;
        }
    </script>

    <!-- Load module with cache busting -->
    <script src="/js/rencana-strategis.js?v=<?php echo time(); ?>&nocache=<?php echo rand(); ?>"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Starting Direct Table Test...');
            
            document.getElementById('status').textContent = 'Loading...';
            
            try {
                // Wait for module to be available
                let attempts = 0;
                while (!window.RencanaStrategisModule && attempts < 10) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (!window.RencanaStrategisModule) {
                    throw new Error('RencanaStrategisModule not found after 10 attempts');
                }
                
                document.getElementById('status').textContent = 'Module found, loading...';
                
                // Load the module
                await window.RencanaStrategisModule.load();
                
                document.getElementById('status').innerHTML = '<span class="success">‚úÖ Module loaded successfully</span>';
                
                // Check view immediately
                setTimeout(() => {
                    const currentView = updateDebugInfo();
                    
                    if (currentView === 'Table View') {
                        document.getElementById('status').innerHTML = '<span class="success">‚úÖ SUCCESS: Table view is displayed as default!</span>';
                    } else {
                        document.getElementById('status').innerHTML = '<span class="error">‚ùå ISSUE: ' + currentView + ' is displayed instead of Table View</span>';
                        
                        // Try to force table view
                        console.log('üîß Attempting to force table view...');
                        if (window.RencanaStrategisModule.showTableView) {
                            window.RencanaStrategisModule.showTableView();
                            
                            setTimeout(() => {
                                const newView = updateDebugInfo();
                                if (newView === 'Table View') {
                                    document.getElementById('status').innerHTML = '<span class="warning">‚ö†Ô∏è FIXED: Table view forced to display</span>';
                                }
                            }, 500);
                        }
                    }
                }, 1000);
                
                // Set up periodic updates
                setInterval(updateDebugInfo, 2000);
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                document.getElementById('status').innerHTML = '<span class="error">‚ùå ERROR: ' + error.message + '</span>';
            }
        });
    </script>
</body>
</html>