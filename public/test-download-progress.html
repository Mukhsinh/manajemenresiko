<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Download Progress & Notifications</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .btn-test {
            margin: 0.5rem;
            min-width: 200px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        .status-info { background-color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1><i class="fas fa-download"></i> Test Download Progress & Notifications</h1>
        <p class="text-muted">Testing progress bar dan notifikasi untuk download laporan</p>

        <!-- Status Overview -->
        <div class="test-section">
            <h3><i class="fas fa-info-circle"></i> Status Overview</h3>
            <div id="status-overview">
                <p><span class="status-indicator status-info"></span> Initializing tests...</p>
            </div>
        </div>

        <!-- Excel Download Tests -->
        <div class="test-section">
            <h3><i class="fas fa-file-excel"></i> Excel Download Tests</h3>
            <p>Test download Excel dengan progress bar dan notifikasi</p>
            
            <button class="btn btn-success btn-test" onclick="testExcelDownload('test')">
                <i class="fas fa-download"></i> Test Excel Download
            </button>
            
            <button class="btn btn-success btn-test" onclick="testExcelDownload('risk-register')">
                <i class="fas fa-download"></i> Risk Register Excel
            </button>
            
            <button class="btn btn-success btn-test" onclick="testExcelDownload('risk-profile')">
                <i class="fas fa-download"></i> Risk Profile Excel
            </button>
        </div>

        <!-- PDF Download Tests -->
        <div class="test-section">
            <h3><i class="fas fa-file-pdf"></i> PDF Download Tests</h3>
            <p>Test download PDF dengan progress bar dan notifikasi</p>
            
            <button class="btn btn-danger btn-test" onclick="testPDFDownload('residual-risk')">
                <i class="fas fa-download"></i> Residual Risk PDF
            </button>
            
            <button class="btn btn-secondary btn-test" onclick="testPDFDownload('risk-register')">
                <i class="fas fa-download"></i> Risk Register PDF (Not Implemented)
            </button>
        </div>

        <!-- Progress & Notification Tests -->
        <div class="test-section">
            <h3><i class="fas fa-cogs"></i> Progress & Notification Tests</h3>
            <p>Test komponen progress bar dan notifikasi secara terpisah</p>
            
            <button class="btn btn-info btn-test" onclick="testProgressModal()">
                <i class="fas fa-spinner"></i> Test Progress Modal
            </button>
            
            <button class="btn btn-success btn-test" onclick="testSuccessNotification()">
                <i class="fas fa-check"></i> Test Success Notification
            </button>
            
            <button class="btn btn-danger btn-test" onclick="testErrorNotification()">
                <i class="fas fa-times"></i> Test Error Notification
            </button>
        </div>

        <!-- File Validation Tests -->
        <div class="test-section">
            <h3><i class="fas fa-file-check"></i> File Validation Tests</h3>
            <p>Test validasi format file yang didownload</p>
            
            <button class="btn btn-warning btn-test" onclick="testFileValidation()">
                <i class="fas fa-search"></i> Test File Validation
            </button>
            
            <div id="validation-results" class="mt-3"></div>
        </div>

        <!-- Live Laporan Module -->
        <div class="test-section">
            <h3><i class="fas fa-eye"></i> Live Laporan Module</h3>
            <p>Test modul laporan dengan progress bar terintegrasi</p>
            
            <button class="btn btn-primary btn-test" onclick="loadLaporanModule()">
                <i class="fas fa-play"></i> Load Laporan Module
            </button>
            
            <div id="laporan-module-container" class="mt-3"></div>
        </div>
    </div>

    <!-- Include required scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/config.js"></script>
    <script src="/js/services/apiService.js"></script>
    <script src="/js/laporan.js"></script>

    <script>
        // Test Excel Download with progress
        async function testExcelDownload(reportType) {
            updateStatus('info', `Testing Excel download: ${reportType}`);
            
            try {
                let endpoint;
                if (reportType === 'test') {
                    endpoint = '/api/reports/test-excel-download';
                } else {
                    endpoint = `/api/reports/${reportType}/excel`;
                }
                
                // Use the LaporanModule function if available
                if (typeof LaporanModule !== 'undefined' && LaporanModule.downloadExcel) {
                    await LaporanModule.downloadExcel(reportType, endpoint);
                    updateStatus('success', `Excel download completed: ${reportType}`);
                } else {
                    // Fallback to direct download
                    await directDownload(endpoint, `${reportType}.xlsx`, 'Excel');
                    updateStatus('success', `Excel download completed: ${reportType}`);
                }
            } catch (error) {
                updateStatus('error', `Excel download failed: ${error.message}`);
            }
        }

        // Test PDF Download with progress
        async function testPDFDownload(reportType) {
            updateStatus('info', `Testing PDF download: ${reportType}`);
            
            try {
                const endpoint = `/api/reports/${reportType}/pdf`;
                
                // Use the LaporanModule function if available
                if (typeof LaporanModule !== 'undefined' && LaporanModule.downloadPDF) {
                    await LaporanModule.downloadPDF(reportType, endpoint);
                    updateStatus('success', `PDF download completed: ${reportType}`);
                } else {
                    // Fallback to direct download
                    await directDownload(endpoint, `${reportType}.pdf`, 'PDF');
                    updateStatus('success', `PDF download completed: ${reportType}`);
                }
            } catch (error) {
                updateStatus('error', `PDF download failed: ${error.message}`);
            }
        }

        // Direct download with progress simulation
        async function directDownload(url, filename, type) {
            const progressModal = showProgressModal(`Mengunduh ${type}`, 'Mempersiapkan download...');
            
            try {
                updateProgress(progressModal, 20, 'Menghubungi server...');
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                updateProgress(progressModal, 60, 'Memproses file...');
                
                const blob = await response.blob();
                
                updateProgress(progressModal, 90, 'Menyiapkan download...');
                
                // Trigger download
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);
                
                updateProgress(progressModal, 100, 'Download selesai!');
                
                setTimeout(() => {
                    hideProgressModal(progressModal);
                    showSuccessNotification(`${type} berhasil diunduh!`, filename);
                }, 1000);
                
            } catch (error) {
                hideProgressModal(progressModal);
                showErrorNotification(`Error Download ${type}`, error.message);
                throw error;
            }
        }

        // Test Progress Modal
        async function testProgressModal() {
            updateStatus('info', 'Testing progress modal');
            
            const modal = showProgressModal('Test Progress Modal', 'Starting test...');
            
            const steps = [
                { progress: 20, message: 'Step 1: Initializing...' },
                { progress: 40, message: 'Step 2: Processing...' },
                { progress: 60, message: 'Step 3: Validating...' },
                { progress: 80, message: 'Step 4: Finalizing...' },
                { progress: 100, message: 'Test completed!' }
            ];
            
            for (const step of steps) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                updateProgress(modal, step.progress, step.message);
            }
            
            setTimeout(() => {
                hideProgressModal(modal);
                updateStatus('success', 'Progress modal test completed');
            }, 1500);
        }

        // Test Success Notification
        function testSuccessNotification() {
            updateStatus('info', 'Testing success notification');
            showSuccessNotification('Test Success!', 'This is a test success notification');
            updateStatus('success', 'Success notification displayed');
        }

        // Test Error Notification
        function testErrorNotification() {
            updateStatus('info', 'Testing error notification');
            showErrorNotification('Test Error!', 'This is a test error notification');
            updateStatus('success', 'Error notification displayed');
        }

        // Test File Validation
        async function testFileValidation() {
            updateStatus('info', 'Testing file validation');
            const resultsDiv = document.getElementById('validation-results');
            resultsDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Testing...';
            
            try {
                // Test Excel file
                const excelResponse = await fetch('/api/reports/test-excel-download');
                if (excelResponse.ok) {
                    const blob = await excelResponse.blob();
                    const contentType = excelResponse.headers.get('content-type');
                    
                    let results = '<h5>Validation Results:</h5>';
                    results += `<p><strong>Excel File:</strong></p>`;
                    results += `<ul>`;
                    results += `<li>Size: ${blob.size} bytes</li>`;
                    results += `<li>Content-Type: ${contentType}</li>`;
                    
                    // Check file signature
                    const arrayBuffer = await blob.arrayBuffer();
                    const uint8Array = new Uint8Array(arrayBuffer);
                    const signature = Array.from(uint8Array.slice(0, 4)).map(b => b.toString(16).padStart(2, '0')).join('');
                    
                    results += `<li>File Signature: ${signature}</li>`;
                    
                    if (signature === '504b0304') {
                        results += `<li class="text-success">✅ Valid Excel file format</li>`;
                    } else {
                        results += `<li class="text-warning">⚠️ Unexpected file format</li>`;
                    }
                    
                    results += `</ul>`;
                    resultsDiv.innerHTML = results;
                    updateStatus('success', 'File validation completed');
                } else {
                    throw new Error(`HTTP ${excelResponse.status}`);
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="alert alert-danger">Validation failed: ${error.message}</div>`;
                updateStatus('error', `File validation failed: ${error.message}`);
            }
        }

        // Load Laporan Module
        async function loadLaporanModule() {
            updateStatus('info', 'Loading laporan module');
            const container = document.getElementById('laporan-module-container');
            
            try {
                if (typeof LaporanModule !== 'undefined') {
                    container.innerHTML = '<div id="laporan-content"></div>';
                    await LaporanModule.load();
                    updateStatus('success', 'Laporan module loaded successfully');
                } else {
                    throw new Error('LaporanModule not available');
                }
            } catch (error) {
                container.innerHTML = `<div class="alert alert-danger">Failed to load: ${error.message}</div>`;
                updateStatus('error', `Module load failed: ${error.message}`);
            }
        }

        // Status update function
        function updateStatus(type, message) {
            const statusDiv = document.getElementById('status-overview');
            const timestamp = new Date().toLocaleTimeString();
            const statusClass = `status-${type}`;
            
            const statusHtml = `
                <p>
                    <span class="status-indicator ${statusClass}"></span>
                    <small class="text-muted">[${timestamp}]</small>
                    ${message}
                </p>
            `;
            
            statusDiv.innerHTML = statusHtml + statusDiv.innerHTML;
        }

        // Initialize page
        window.addEventListener('load', () => {
            updateStatus('success', 'Test page loaded successfully');
            
            // Check if LaporanModule is available
            if (typeof LaporanModule !== 'undefined') {
                updateStatus('success', 'LaporanModule is available');
            } else {
                updateStatus('warning', 'LaporanModule not found - some tests may not work');
            }
        });
    </script>
</body>
</html>