<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Supabase Client Initialization Fix</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-card {
            margin-bottom: 1rem;
            border-left: 4px solid #007bff;
        }
        .test-success {
            border-left-color: #28a745;
            background-color: #f8fff9;
        }
        .test-error {
            border-left-color: #dc3545;
            background-color: #fff8f8;
        }
        .test-warning {
            border-left-color: #ffc107;
            background-color: #fffdf5;
        }
        .log-output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-pending { background-color: #6c757d; }
        .status-running { background-color: #007bff; animation: pulse 1s infinite; }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-flask"></i>
                            Test Supabase Client Initialization Fix
                        </h3>
                        <p class="text-muted mb-0">Verifikasi bahwa perbaikan race condition Supabase client berfungsi dengan baik</p>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5>Test Cases</h5>
                                <div id="test-cases">
                                    <!-- Test cases will be populated here -->
                                </div>
                                
                                <div class="mt-3">
                                    <button id="run-tests" class="btn btn-primary">
                                        <i class="fas fa-play"></i> Run All Tests
                                    </button>
                                    <button id="clear-logs" class="btn btn-secondary">
                                        <i class="fas fa-trash"></i> Clear Logs
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h5>Console Output</h5>
                                <div id="log-output" class="log-output">
                                    <div class="text-muted">Logs will appear here...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="/js/config.js"></script>
    <script src="/js/services/apiService.js"></script>

    <script>
        // Test framework
        class TestRunner {
            constructor() {
                this.tests = [];
                this.results = [];
                this.logOutput = document.getElementById('log-output');
                this.testCasesContainer = document.getElementById('test-cases');
                
                // Override console methods to capture logs
                this.originalConsole = {
                    log: console.log,
                    error: console.error,
                    warn: console.warn,
                    info: console.info
                };
                
                this.setupConsoleCapture();
                this.setupTests();
                this.renderTestCases();
            }
            
            setupConsoleCapture() {
                const self = this;
                
                ['log', 'error', 'warn', 'info'].forEach(method => {
                    console[method] = function(...args) {
                        self.originalConsole[method].apply(console, args);
                        self.addLog(method, args.join(' '));
                    };
                });
            }
            
            addLog(level, message) {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${level}`;
                
                let icon = 'üìù';
                if (level === 'error') icon = '‚ùå';
                else if (level === 'warn') icon = '‚ö†Ô∏è';
                else if (level === 'info') icon = '‚ÑπÔ∏è';
                
                logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${icon} ${message}`;
                this.logOutput.appendChild(logEntry);
                this.logOutput.scrollTop = this.logOutput.scrollHeight;
            }
            
            setupTests() {
                this.tests = [
                    {
                        id: 'test-manager-exists',
                        name: 'SupabaseClientManager Exists',
                        description: 'Verify SupabaseClientManager is available globally',
                        test: this.testManagerExists.bind(this)
                    },
                    {
                        id: 'test-manager-methods',
                        name: 'Manager Methods Available',
                        description: 'Check all required methods are present',
                        test: this.testManagerMethods.bind(this)
                    },
                    {
                        id: 'test-initialization',
                        name: 'Client Initialization',
                        description: 'Test Supabase client initialization process',
                        test: this.testInitialization.bind(this)
                    },
                    {
                        id: 'test-wait-mechanism',
                        name: 'Wait Mechanism',
                        description: 'Test waitForClient functionality',
                        test: this.testWaitMechanism.bind(this)
                    },
                    {
                        id: 'test-api-service',
                        name: 'API Service Integration',
                        description: 'Test getAuthToken with new client manager',
                        test: this.testApiService.bind(this)
                    },
                    {
                        id: 'test-backward-compatibility',
                        name: 'Backward Compatibility',
                        description: 'Ensure old configManager still works',
                        test: this.testBackwardCompatibility.bind(this)
                    }
                ];
            }
            
            renderTestCases() {
                this.testCasesContainer.innerHTML = '';
                
                this.tests.forEach(test => {
                    const testCard = document.createElement('div');
                    testCard.className = 'card test-card';
                    testCard.id = `card-${test.id}`;
                    
                    testCard.innerHTML = `
                        <div class="card-body py-2">
                            <div class="d-flex align-items-center">
                                <span id="status-${test.id}" class="status-indicator status-pending"></span>
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">${test.name}</h6>
                                    <small class="text-muted">${test.description}</small>
                                </div>
                                <div id="result-${test.id}" class="text-muted">
                                    <small>Pending</small>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    this.testCasesContainer.appendChild(testCard);
                });
            }
            
            updateTestStatus(testId, status, message = '') {
                const statusIndicator = document.getElementById(`status-${testId}`);
                const resultDiv = document.getElementById(`result-${testId}`);
                const card = document.getElementById(`card-${testId}`);
                
                statusIndicator.className = `status-indicator status-${status}`;
                
                if (status === 'success') {
                    card.classList.add('test-success');
                    resultDiv.innerHTML = '<small class="text-success"><i class="fas fa-check"></i> Passed</small>';
                } else if (status === 'error') {
                    card.classList.add('test-error');
                    resultDiv.innerHTML = `<small class="text-danger"><i class="fas fa-times"></i> Failed</small>`;
                } else if (status === 'warning') {
                    card.classList.add('test-warning');
                    resultDiv.innerHTML = `<small class="text-warning"><i class="fas fa-exclamation-triangle"></i> Warning</small>`;
                } else if (status === 'running') {
                    resultDiv.innerHTML = '<small class="text-primary"><i class="fas fa-spinner fa-spin"></i> Running...</small>';
                }
                
                if (message) {
                    console.log(`Test ${testId}: ${message}`);
                }
            }
            
            async runAllTests() {
                console.log('üß™ Starting Supabase Client Fix Tests...');
                this.results = [];
                
                for (const test of this.tests) {
                    try {
                        this.updateTestStatus(test.id, 'running');
                        console.log(`\nüîç Running test: ${test.name}`);
                        
                        const result = await test.test();
                        
                        if (result.success) {
                            this.updateTestStatus(test.id, 'success', result.message);
                            this.results.push({ test: test.id, status: 'success', message: result.message });
                        } else {
                            this.updateTestStatus(test.id, 'error', result.message);
                            this.results.push({ test: test.id, status: 'error', message: result.message });
                        }
                    } catch (error) {
                        this.updateTestStatus(test.id, 'error', error.message);
                        this.results.push({ test: test.id, status: 'error', message: error.message });
                        console.error(`Test ${test.id} failed:`, error);
                    }
                    
                    // Small delay between tests
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                this.showSummary();
            }
            
            showSummary() {
                const passed = this.results.filter(r => r.status === 'success').length;
                const failed = this.results.filter(r => r.status === 'error').length;
                const total = this.results.length;
                
                console.log(`\nüìä Test Summary:`);
                console.log(`‚úÖ Passed: ${passed}/${total}`);
                console.log(`‚ùå Failed: ${failed}/${total}`);
                
                if (failed === 0) {
                    console.log('üéâ All tests passed! Supabase client fix is working correctly.');
                } else {
                    console.log('‚ö†Ô∏è Some tests failed. Please check the implementation.');
                }
            }
            
            // Test implementations
            async testManagerExists() {
                if (typeof window.SupabaseClientManager === 'undefined') {
                    return { success: false, message: 'SupabaseClientManager not found in global scope' };
                }
                
                if (typeof window.SupabaseClientManager !== 'object') {
                    return { success: false, message: 'SupabaseClientManager is not an object' };
                }
                
                return { success: true, message: 'SupabaseClientManager exists and is accessible' };
            }
            
            async testManagerMethods() {
                const manager = window.SupabaseClientManager;
                const requiredMethods = ['initialize', 'getClient', 'waitForClient', 'isClientReady'];
                
                for (const method of requiredMethods) {
                    if (typeof manager[method] !== 'function') {
                        return { success: false, message: `Method ${method} is missing or not a function` };
                    }
                }
                
                return { success: true, message: 'All required methods are present' };
            }
            
            async testInitialization() {
                const manager = window.SupabaseClientManager;
                
                try {
                    // Test initialization
                    const client = await manager.initialize();
                    
                    if (!client) {
                        return { success: false, message: 'Initialize returned null/undefined' };
                    }
                    
                    // Check if client has auth methods
                    if (!client.auth || typeof client.auth.getSession !== 'function') {
                        return { success: false, message: 'Client does not have required auth methods' };
                    }
                    
                    return { success: true, message: 'Client initialized successfully with auth methods' };
                } catch (error) {
                    return { success: false, message: `Initialization failed: ${error.message}` };
                }
            }
            
            async testWaitMechanism() {
                const manager = window.SupabaseClientManager;
                
                try {
                    const startTime = Date.now();
                    const client = await manager.waitForClient(5000);
                    const endTime = Date.now();
                    
                    if (!client) {
                        return { success: false, message: 'waitForClient returned null/undefined' };
                    }
                    
                    const waitTime = endTime - startTime;
                    return { success: true, message: `Client ready in ${waitTime}ms` };
                } catch (error) {
                    return { success: false, message: `Wait mechanism failed: ${error.message}` };
                }
            }
            
            async testApiService() {
                try {
                    // Test if getAuthToken works with new manager
                    if (typeof window.getAuthToken !== 'function') {
                        return { success: false, message: 'getAuthToken function not available' };
                    }
                    
                    // This should not throw an error about client not being ready
                    try {
                        const token = await window.getAuthToken();
                        // Token can be null if user is not logged in, that's OK
                        return { success: true, message: 'getAuthToken executed without client initialization errors' };
                    } catch (error) {
                        if (error.message.includes('sedang memuat') || error.message.includes('tidak tersedia')) {
                            return { success: false, message: 'Still getting client initialization errors' };
                        } else {
                            // Other errors (like no session) are expected and OK
                            return { success: true, message: 'getAuthToken works (session-related error is expected)' };
                        }
                    }
                } catch (error) {
                    return { success: false, message: `API service test failed: ${error.message}` };
                }
            }
            
            async testBackwardCompatibility() {
                // Test that old configManager still works
                if (typeof window.configManager === 'undefined') {
                    return { success: false, message: 'configManager not available for backward compatibility' };
                }
                
                const configManager = window.configManager;
                const requiredMethods = ['loadConfig', 'isReady', 'waitForSupabaseClient', 'onConfigReady'];
                
                for (const method of requiredMethods) {
                    if (typeof configManager[method] !== 'function') {
                        return { success: false, message: `configManager.${method} is missing or not a function` };
                    }
                }
                
                // Test that isReady works
                const isReady = configManager.isReady();
                
                return { success: true, message: `Backward compatibility maintained, isReady: ${isReady}` };
            }
            
            clearLogs() {
                this.logOutput.innerHTML = '<div class="text-muted">Logs cleared...</div>';
            }
        }
        
        // Initialize test runner when page loads
        document.addEventListener('DOMContentLoaded', () => {
            const testRunner = new TestRunner();
            
            document.getElementById('run-tests').addEventListener('click', () => {
                testRunner.runAllTests();
            });
            
            document.getElementById('clear-logs').addEventListener('click', () => {
                testRunner.clearLogs();
            });
            
            // Auto-run tests after a short delay to let everything initialize
            setTimeout(() => {
                console.log('üöÄ Auto-running tests in 2 seconds...');
                setTimeout(() => {
                    testRunner.runAllTests();
                }, 2000);
            }, 1000);
        });
    </script>
</body>
</html>