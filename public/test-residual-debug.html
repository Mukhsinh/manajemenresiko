<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Residual Risk Debug Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .debug-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.875rem;
        }
        .error { color: #dc3545; }
        .success { color: #198754; }
        .info { color: #0d6efd; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2>Residual Risk Debug Test</h2>
        
        <div class="row">
            <div class="col-12">
                <button class="btn btn-primary" onclick="testAPI()">Test API</button>
                <button class="btn btn-secondary" onclick="clearLog()">Clear Log</button>
            </div>
        </div>
        
        <div id="debug-log" class="debug-panel mt-3">
            <div class="info">Click "Test API" to start debugging...</div>
        </div>
        
        <div id="data-display" class="mt-3"></div>
    </div>

    <script>
        let debugLog = document.getElementById('debug-log');
        let dataDisplay = document.getElementById('data-display');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `[${timestamp}] ${message}`;
            debugLog.appendChild(div);
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearLog() {
            debugLog.innerHTML = '<div class="info">Log cleared...</div>';
            dataDisplay.innerHTML = '';
        }
        
        async function testAPI() {
            try {
                log('Starting API test...', 'info');
                
                const apiUrl = '/api/reports/residual-risk-simple';
                log(`Fetching from: ${apiUrl}`, 'info');
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                
                log(`Response status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                log(`Data received: ${data.length} records`, 'success');
                
                if (data.length > 0) {
                    log('Sample record structure:', 'info');
                    log(`Keys: ${Object.keys(data[0]).join(', ')}`, 'info');
                    
                    if (data[0].risk_inputs) {
                        log('risk_inputs found', 'success');
                        log(`risk_inputs keys: ${Object.keys(data[0].risk_inputs).join(', ')}`, 'info');
                        
                        if (data[0].risk_inputs.risk_inherent_analysis) {
                            const inherent = data[0].risk_inputs.risk_inherent_analysis;
                            log(`risk_inherent_analysis type: ${Array.isArray(inherent) ? 'Array' : 'Object'}`, 'info');
                            
                            if (Array.isArray(inherent)) {
                                log(`Array length: ${inherent.length}`, 'info');
                                if (inherent.length > 0) {
                                    log(`First item keys: ${Object.keys(inherent[0]).join(', ')}`, 'info');
                                }
                            } else {
                                log(`Object keys: ${Object.keys(inherent).join(', ')}`, 'info');
                            }
                        } else {
                            log('risk_inherent_analysis not found', 'error');
                        }
                    } else {
                        log('risk_inputs not found', 'error');
                    }
                }
                
                // Test the statistics calculation
                log('Testing statistics calculation...', 'info');
                const stats = calculateStatistics(data);
                log(`Statistics: Total=${stats.total}, AvgInherent=${stats.avgInherent.toFixed(2)}, AvgResidual=${stats.avgResidual.toFixed(2)}`, 'success');
                
                // Display the data
                displayData(data, stats);
                
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }
        
        function calculateStatistics(residualData) {
            let totalInherent = 0;
            let totalResidual = 0;
            let validInherentCount = 0;
            let riskLevelCounts = {
                'LOW RISK': 0,
                'MEDIUM RISK': 0,
                'HIGH RISK': 0,
                'EXTREME HIGH': 0,
                'VERY HIGH': 0
            };
            
            residualData.forEach(item => {
                const risk = item.risk_inputs || {};
                let inherent = {};
                
                // Try to get inherent data - handle both array and object formats
                if (risk.risk_inherent_analysis) {
                    if (Array.isArray(risk.risk_inherent_analysis) && risk.risk_inherent_analysis.length > 0) {
                        inherent = risk.risk_inherent_analysis[0];
                    } else if (!Array.isArray(risk.risk_inherent_analysis)) {
                        inherent = risk.risk_inherent_analysis;
                    }
                }
                
                const inherentValue = parseFloat(inherent.risk_value) || 0;
                const residualValue = parseFloat(item.risk_value) || 0;
                
                if (inherentValue > 0) {
                    totalInherent += inherentValue;
                    validInherentCount++;
                }
                
                if (residualValue > 0) {
                    totalResidual += residualValue;
                }
                
                // Count risk levels
                const riskLevel = (item.risk_level || '').toUpperCase();
                if (riskLevel.includes('LOW')) {
                    riskLevelCounts['LOW RISK']++;
                } else if (riskLevel.includes('MEDIUM')) {
                    riskLevelCounts['MEDIUM RISK']++;
                } else if (riskLevel.includes('HIGH') && !riskLevel.includes('EXTREME')) {
                    riskLevelCounts['HIGH RISK']++;
                } else if (riskLevel.includes('EXTREME') || riskLevel.includes('VERY HIGH')) {
                    riskLevelCounts['EXTREME HIGH']++;
                }
            });

            const avgInherent = validInherentCount > 0 ? totalInherent / validInherentCount : 0;
            const avgResidual = residualData.length > 0 ? totalResidual / residualData.length : 0;
            const reduction = avgInherent > 0 ? ((avgInherent - avgResidual) / avgInherent * 100).toFixed(1) : '0.0';

            return {
                total: residualData.length,
                avgInherent: avgInherent,
                avgResidual: avgResidual,
                reduction: reduction,
                riskLevelCounts: riskLevelCounts,
                validInherentCount: validInherentCount
            };
        }
        
        function displayData(data, stats) {
            dataDisplay.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h5>Data Display Test</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h3>${stats.total}</h3>
                                        <p>Total Records</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h3>${stats.avgInherent.toFixed(2)}</h3>
                                        <p>Avg Inherent</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h3>${stats.avgResidual.toFixed(2)}</h3>
                                        <p>Avg Residual</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-white">
                                    <div class="card-body text-center">
                                        <h3>${stats.reduction}%</h3>
                                        <p>Reduction</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive mt-3">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>Kode Risiko</th>
                                        <th>Unit Kerja</th>
                                        <th>Inherent</th>
                                        <th>Residual</th>
                                        <th>Level</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.slice(0, 5).map((item, index) => {
                                        const risk = item.risk_inputs || {};
                                        
                                        // Get inherent data
                                        let inherent = {};
                                        if (risk.risk_inherent_analysis) {
                                            if (Array.isArray(risk.risk_inherent_analysis) && risk.risk_inherent_analysis.length > 0) {
                                                inherent = risk.risk_inherent_analysis[0];
                                            } else if (!Array.isArray(risk.risk_inherent_analysis)) {
                                                inherent = risk.risk_inherent_analysis;
                                            }
                                        }
                                        
                                        const inherentValue = parseFloat(inherent.risk_value) || 0;
                                        const residualValue = parseFloat(item.risk_value) || 0;
                                        
                                        return `
                                            <tr>
                                                <td>${index + 1}</td>
                                                <td>${risk.kode_risiko || '-'}</td>
                                                <td>${risk.master_work_units?.name || '-'}</td>
                                                <td>${inherentValue}</td>
                                                <td>${residualValue}</td>
                                                <td>${item.risk_level || '-'}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>